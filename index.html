<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PPTX to Scrollytelling Converter - Convert PowerPoint presentations to interactive scrollytelling sites">
    <title>PPTX to Scrollytelling Converter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* GafComment: Reset and base styles for accessibility and consistency */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: #1a1a1a;
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
        }

        /* GafComment: Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: #fff;
            padding: 8px;
            z-index: 100;
        }
        .skip-link:focus { top: 0; }

        /* GafComment: Main container with max-width for readability */
        .container { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 3rem; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #1a1a1a; }
        .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 2rem; }

        /* GafComment: Two-column grid for upload and customization */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .box { 
            padding: 2rem;
            border-radius: 0.75rem;
            background: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .box h2 { font-size: 1.2rem; margin-bottom: 1.5rem; color: #1a1a1a; }

        /* GafComment: Form elements with focus states for accessibility */
        .form-group { margin-bottom: 1.5rem; }
        label { 
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            color: #333;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #ddd;
            background: #fff;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="file"]:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        /* GafComment: Theme detection display with color swatches */
        .theme-display {
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 0.5rem;
            border: 1px solid #eee;
            margin-top: 1rem;
            display: none;
        }
        .theme-display.show { display: block; }
        .theme-item { margin-bottom: 0.75rem; font-size: 0.9rem; }
        .color-swatch {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #ccc;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        /* GafComment: Drop zone for file upload */
        .drop-zone {
            border: 2px dashed #999;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        .drop-zone:hover { border-color: #0066cc; background: #f0f5ff; }
        .drop-zone.over { border-color: #0066cc; background: #e6f0ff; }
        .drop-zone p { margin: 0.5rem 0; color: #666; }

        /* GafComment: File input hidden, drop zone is the trigger */
        input[type="file"] { display: none; }

        /* GafComment: Status messages with semantic colors */
        .file-info, .msg {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            display: none;
            font-size: 0.9rem;
        }
        .file-info.show, .msg.show { display: block; }
        .file-info { background: #e6f9e6; border-color: #22c55e; color: #166534; }
        .msg.ok { background: #e6f9e6; border-color: #22c55e; color: #166534; }
        .msg.err { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .msg.info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }

        /* GafComment: Button styles with focus states */
        .buttons { display: flex; gap: 1rem; margin-top: 2rem; }
        button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:focus { outline: 2px solid #0066cc; outline-offset: 2px; }
        .btn-main {
            background: #0066cc;
            color: #fff;
        }
        .btn-main:hover:not(:disabled) { background: #0052a3; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sec {
            background: #f0f0f0;
            color: #1a1a1a;
            border: 1px solid #ddd;
        }
        .btn-sec:hover { background: #e8e8e8; }

        /* GafComment: Loading spinner animation */
        .loading { display: none; text-align: center; padding: 2rem; }
        .loading.show { display: block; }
        .spinner {
            border: 4px solid #f0f0f0;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* GafComment: Preview section with iframe */
        .preview { display: none; margin-top: 2rem; padding: 2rem; background: #fff; border-radius: 0.75rem; border: 1px solid #ddd; }
        .preview.show { display: block; }
        .preview h3 { margin-bottom: 1rem; color: #1a1a1a; }
        .preview-iframe { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 0.5rem; background: #fff; }

        /* GafComment: Accessibility: prefers-reduced-motion support */
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }

        /* GafComment: Mobile responsive design */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
            .preview-iframe { height: 400px; }
        }

        /* GafComment: High contrast mode support */
        @media (prefers-contrast: more) {
            body { background: #fff; }
            .box { border: 2px solid #000; }
            button { border: 2px solid #000; }
        }
    </style>
</head>
<body>
    <!-- GafComment: Skip link for keyboard navigation accessibility -->
    <a href="#main" class="skip-link">Skip to main content</a>

    <div class="container">
        <header>
            <h1>PPTX to Scrollytelling</h1>
            <p class="subtitle">Convert your PowerPoint presentations to interactive scrollytelling sites. Processing happens locally on your computer.</p>
        </header>

        <main id="main">
            <!-- GafComment: Two-column layout: upload on left, customization on right -->
            <div class="grid">
                <!-- GafComment: File upload section -->
                <div class="box">
                    <h2>Upload PPTX</h2>
                    <div class="drop-zone" id="dropZone" role="button" tabindex="0" aria-label="Drop PPTX file here or click to browse">
                        <p style="font-size: 2rem; margin-bottom: 0.5rem;">üì§</p>
                        <p><strong>Drag & drop PPTX here</strong></p>
                        <p style="color: #999; font-size: 0.9rem;">or click to browse</p>
                        <input type="file" id="fileInput" accept=".pptx" aria-label="Select PPTX file">
                    </div>
                    <div class="file-info" id="fileInfo"></div>
                    <div class="msg" id="uploadStatus" role="status" aria-live="polite" aria-atomic="true"></div>
                </div>

                <!-- GafComment: Theme detection display section -->
                <div class="box">
                    <h2>Detected Theme</h2>
                    <div class="theme-display" id="themeDisplay" role="region" aria-label="Detected theme information">
                        <div class="theme-item" id="fontInfo"></div>
                        <div class="theme-item" id="colorInfo"></div>
                        <div class="theme-item" id="bgInfo"></div>
                    </div>
                    <div style="padding: 1rem; background: #f0f5ff; border-radius: 0.5rem; border-left: 4px solid #3b82f6; color: #1e40af; font-size: 0.9rem; margin-top: 1rem;">
                        <strong>‚ÑπÔ∏è How it works:</strong> Upload a PPTX file and the converter will automatically extract the theme colors, fonts, and images. The generated scrollytelling site will match your presentation's visual style.
                    </div>
                </div>
            </div>

            <!-- GafComment: Loading indicator with spinner -->
            <div id="loading" class="loading" role="status" aria-live="polite" aria-atomic="true">
                <div class="spinner"></div>
                <p id="loadingText">Processing your presentation...</p>
            </div>

            <!-- GafComment: Preview section with iframe sandbox -->
            <div class="preview" id="preview" role="region" aria-label="Generated site preview">
                <h3>Preview</h3>
                <iframe id="previewIframe" class="preview-iframe" title="Preview of generated scrollytelling site" sandbox="allow-same-origin"></iframe>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn-sec" id="editBtn">‚Üê Edit & Regenerate</button>
                    <button class="btn-main" id="downloadBtn">‚úì Download ZIP</button>
                </div>
            </div>

            <!-- GafComment: Action buttons -->
            <div class="buttons">
                <button class="btn-main" id="generateBtn" disabled aria-label="Generate preview from uploaded PPTX">Generate Preview</button>
                <button class="btn-sec" id="resetBtn" aria-label="Reset form and clear all inputs">Reset</button>
            </div>
        </main>
    </div>

    <script>
        /* GafComment: Global state management */
        var selectedFile = null;
        var extractedTheme = null;
        var generatedHTML = null;
        var generatedZip = null;
        var accessibilityReport = [];

        /* GafComment: DOM element references */
        var dropZone = document.getElementById('dropZone');
        var fileInput = document.getElementById('fileInput');
        var fileInfo = document.getElementById('fileInfo');
        var uploadStatus = document.getElementById('uploadStatus');
        var themeDisplay = document.getElementById('themeDisplay');
        var fontInfo = document.getElementById('fontInfo');
        var colorInfo = document.getElementById('colorInfo');
        var bgInfo = document.getElementById('bgInfo');
        var loading = document.getElementById('loading');
        var loadingText = document.getElementById('loadingText');
        var preview = document.getElementById('preview');
        var previewIframe = document.getElementById('previewIframe');
        var generateBtn = document.getElementById('generateBtn');
        var downloadBtn = document.getElementById('downloadBtn');
        var editBtn = document.getElementById('editBtn');
        var resetBtn = document.getElementById('resetBtn');

        /* GafComment: File upload handlers - drag and drop + click */
        dropZone.addEventListener('click', function() { fileInput.click(); });
        dropZone.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('over');
        });

        dropZone.addEventListener('dragleave', function() {
            dropZone.classList.remove('over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('over');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', function(e) {
            handleFile(e.target.files[0]);
        });

        /* GafComment: File validation and state update */
        function handleFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.pptx')) {
                showStatus('Please select a valid PPTX file. Legacy PPT format is not supported.', 'err');
                return;
            }

            selectedFile = file;
            fileInfo.textContent = 'OK ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
            fileInfo.classList.add('show');
            generateBtn.disabled = false;
            showStatus('File ready to process!', 'ok');
        }

        /* GafComment: Status message display with semantic HTML */
        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = 'msg show ' + type;
        }

        /* GafComment: Generate preview button handler */
        generateBtn.addEventListener('click', function() {
            if (!selectedFile) return;
            
            loading.classList.add('show');
            generateBtn.disabled = true;
            preview.classList.remove('show');
            accessibilityReport = [];
            
            var reader = new FileReader();
            reader.onload = function(e) {
                JSZip.loadAsync(e.target.result).then(function(pptxZip) {
                    loadingText.textContent = 'Extracting theme...';
                    extractedTheme = extractTheme(pptxZip);
                    displayTheme(extractedTheme);

                    loadingText.textContent = 'Parsing slides...';
                    var slides = parseSlides(pptxZip);

                    loadingText.textContent = 'Generating HTML...';
                    generatedHTML = generateScrollytellingHTML(slides, extractedTheme);

                    loadingText.textContent = 'Creating download package...';
                    generatedZip = createOutputZip(slides, pptxZip, extractedTheme);

                    loading.classList.remove('show');
                    generateBtn.disabled = false;

                    previewIframe.srcdoc = generatedHTML;
                    preview.classList.add('show');

                    showStatus('OK Preview ready! Review and download below.', 'ok');
                }).catch(function(error) {
                    console.error('Error:', error);
                    loading.classList.remove('show');
                    generateBtn.disabled = false;
                    showStatus('Error: ' + error.message, 'err');
                });
            };
            reader.readAsArrayBuffer(selectedFile);
        });

        /* GafComment: Extract theme colors and fonts from PPTX */
        function extractTheme(pptxZip) {
            var theme = {
                fonts: { major: 'Roboto', minor: 'Roboto' },
                colors: {
                    primary: '#0066cc',
                    secondary: '#00cc99',
                    background: '#ffffff',
                    foreground: '#1a1a1a'
                },
                warnings: []
            };

            try {
                var themeFile = pptxZip.file('ppt/theme/theme1.xml');
                if (themeFile) {
                    var themeXml = themeFile.asText();
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(themeXml, 'text/xml');

                    var fontScheme = doc.querySelector('a\\:fontScheme');
                    if (fontScheme) {
                        var majorFont = fontScheme.querySelector('a\\:majorFont > a\\:latin');
                        var minorFont = fontScheme.querySelector('a\\:minorFont > a\\:latin');
                        if (majorFont) theme.fonts.major = majorFont.getAttribute('typeface') || 'Roboto';
                        if (minorFont) theme.fonts.minor = minorFont.getAttribute('typeface') || 'Roboto';
                    }

                    var colorScheme = doc.querySelector('a\\:clrScheme');
                    if (colorScheme) {
                        var accent1 = colorScheme.querySelector('a\\:accent1 > a\\:srgbClr');
                        var accent2 = colorScheme.querySelector('a\\:accent2 > a\\:srgbClr');
                        if (accent1) theme.colors.primary = '#' + accent1.getAttribute('val');
                        if (accent2) theme.colors.secondary = '#' + accent2.getAttribute('val');
                    }
                }
            } catch (e) {
                theme.warnings.push('Could not parse theme.xml');
                accessibilityReport.push('WARNING: Theme extraction failed, using defaults');
            }

            return theme;
        }

        /* GafComment: Display detected theme in UI */
        function displayTheme(theme) {
            fontInfo.innerHTML = '<strong>Fonts:</strong> ' + theme.fonts.major + ', ' + theme.fonts.minor;
            colorInfo.innerHTML = '<strong>Colors:</strong> <span class="color-swatch" style="background: ' + theme.colors.primary + '"></span> ' + theme.colors.primary + ' <span class="color-swatch" style="background: ' + theme.colors.secondary + '"></span> ' + theme.colors.secondary;
            bgInfo.innerHTML = '<strong>Background:</strong> ' + theme.colors.background;
            themeDisplay.classList.add('show');
        }

        /* GafComment: Parse slides from PPTX */
        function parseSlides(pptxZip) {
            var slides = [];
            var slideFolder = pptxZip.folder('ppt/slides');
            
            if (!slideFolder) return slides;

            var slideFiles = Object.keys(slideFolder.files)
                .filter(function(f) { return f.match(/slide\d+\.xml$/) && !f.includes('_rels'); })
                .sort(function(a, b) {
                    var numA = parseInt(a.match(/\d+/)[0]);
                    var numB = parseInt(b.match(/\d+/)[0]);
                    return numA - numB;
                });

            for (var i = 0; i < slideFiles.length; i++) {
                var slideFile = slideFiles[i];
                var slideNum = slideFile.match(/\d+/)[0];
                var xmlContent = slideFolder.file(slideFile).asText();
                
                var parser = new DOMParser();
                var doc = parser.parseFromString(xmlContent, 'text/xml');
                
                var textNodes = doc.querySelectorAll('a\\:t');
                var text = '';
                for (var j = 0; j < textNodes.length; j++) {
                    text += textNodes[j].textContent + ' ';
                }

                slides.push({
                    number: parseInt(slideNum),
                    text: text.trim(),
                    images: []
                });
            }

            return slides;
        }

        /* GafComment: Generate scrollytelling HTML with theme tokens */
        function generateScrollytellingHTML(slides, theme) {
            var sections = '';
            
            for (var i = 0; i < slides.length; i++) {
                var slide = slides[i];
                var sectionClass = i === 0 ? 'hero' : 'section';
                sections += '<section class="' + sectionClass + '"><div class="overlay"></div><div class="section-content"><h2>Section ' + (i + 1) + '</h2><p>' + escapeHtml(slide.text) + '</p></div></section>';
            }

            var css = ':root{--primary:' + theme.colors.primary + ';--secondary:' + theme.colors.secondary + ';--background:' + theme.colors.background + ';--foreground:' + theme.colors.foreground + '}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:' + theme.fonts.minor + ',-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background:var(--background);color:var(--foreground);line-height:1.6}.progress-bar{position:fixed;top:0;left:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary));z-index:1000;width:0;transition:width 0.3s ease}section{min-height:auto;display:flex;align-items:center;position:relative;overflow:hidden;padding:72px 2rem}@media(min-width:1024px){section{min-height:100vh;padding:0 2rem}}section.hero{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center}section.hero h2{font-size:clamp(2rem,8vw,4rem)}.section-content{max-width:1000px;margin:0 auto;width:100%;position:relative;z-index:10}h2{font-size:clamp(1.5rem,5vw,2.5rem);font-weight:700;margin-bottom:1rem}p{font-size:1.1rem;margin-bottom:1rem}.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:1}footer{padding:2rem;border-top:1px solid var(--primary);text-align:center;color:var(--foreground);opacity:0.7}@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}';

            var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Scrollytelling</title><link href="https://fonts.googleapis.com/css2?family=' + theme.fonts.major + ':wght@400;600;700&display=swap" rel="stylesheet"><style>' + css + '</style></head><body><div class="progress-bar" id="pb"></div>' + sections + '<footer><p>Generated by PPTX to Scrollytelling Converter</p></footer><script>window.addEventListener("scroll",function(){var t=window.scrollY,h=document.documentElement.scrollHeight-window.innerHeight;document.getElementById("pb").style.width=(t/h*100)+"%"})<\/script></body></html>';

            return html;
        }

        /* GafComment: HTML escape for security */
        function escapeHtml(text) {
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        /* GafComment: Create ZIP output with HTML, assets, and accessibility report */
        function createOutputZip(slides, pptxZip, theme) {
            var zip = new JSZip();
            
            zip.file('index.html', generatedHTML);

            var mediaFolder = pptxZip.folder('ppt/media');
            if (mediaFolder) {
                var assetsFolder = zip.folder('assets');
                var mediaFiles = Object.keys(mediaFolder.files);
                
                for (var i = 0; i < mediaFiles.length; i++) {
                    var file = mediaFiles[i];
                    if (file.includes('image') && !file.includes('.emf')) {
                        var imageData = mediaFolder.file(file).asText();
                        var filename = file.split('/').pop();
                        assetsFolder.file(filename, imageData);
                    } else if (file.includes('.emf')) {
                        accessibilityReport.push('WARNING: EMF image detected - not supported in browser');
                    }
                }
            }

            var report = 'ACCESSIBILITY REPORT\n';
            report += '====================\n\n';
            report += 'Generated: ' + new Date().toISOString() + '\n';
            report += 'Fonts: ' + theme.fonts.major + ', ' + theme.fonts.minor + '\n';
            report += 'Colors: Primary=' + theme.colors.primary + ', Secondary=' + theme.colors.secondary + '\n\n';
            report += 'WARNINGS\n';
            if (accessibilityReport.length === 0) {
                report += 'None\n';
            } else {
                for (var j = 0; j < accessibilityReport.length; j++) {
                    report += '- ' + accessibilityReport[j] + '\n';
                }
            }

            zip.file('ACCESSIBILITY_REPORT.txt', report);

            return zip;
        }

        /* GafComment: Download button handler */
        downloadBtn.addEventListener('click', function() {
            if (!generatedZip) return;
            
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';
            
            generatedZip.generateAsync({ type: 'blob' }).then(function(blob) {
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'scrollytelling.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('OK Download complete!', 'ok');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'OK Download ZIP';
            }).catch(function(error) {
                showStatus('Error downloading: ' + error.message, 'err');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'OK Download ZIP';
            });
        });

        /* GafComment: Edit button - return to generation */
        editBtn.addEventListener('click', function() {
            preview.classList.remove('show');
            generateBtn.disabled = false;
        });

        /* GafComment: Reset button - clear all state */
        resetBtn.addEventListener('click', function() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
            generateBtn.disabled = true;
            uploadStatus.classList.remove('show');
            preview.classList.remove('show');
            themeDisplay.classList.remove('show');
            accessibilityReport = [];
        });
    </script>
</body>
</html>
