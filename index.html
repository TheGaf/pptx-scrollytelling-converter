<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTX to Scrollytelling</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #00d9ff;
            color: #0f0a1a;
            padding: 8px;
            text-decoration: none;
            z-index: 10000;
            font-weight: 600;
        }
        .skip-link:focus {
            top: 0;
        }
        
        body { 
            font-family: 'Titillium Web', sans-serif; 
            background: linear-gradient(135deg, #0f0a1a, #1a0a2e); 
            color: #f5f5f5; 
            min-height: 100vh; 
            padding: 2rem; 
        }
        
        /* High contrast mode */
        body[data-contrast="high"] {
            background: #000;
            color: #fff;
        }
        body[data-contrast="high"] .box,
        body[data-contrast="high"] .preview {
            background: #000;
            border: 2px solid #fff;
        }
        body[data-contrast="high"] .btn-main {
            background: #fff;
            color: #000;
            border: 2px solid #fff;
        }
        body[data-contrast="high"] .btn-sec {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
        }
        
        /* Respect prefers-reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 1rem; 
            background: linear-gradient(135deg, #00d9ff, #a855f7); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
        }
        .subtitle { color: rgba(255,255,255,0.6); margin-bottom: 3rem; }
        
        .accessibility-controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .accessibility-controls button {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #f5f5f5;
            border-radius: 0.5rem;
            cursor: pointer;
            font-family: 'Titillium Web', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .accessibility-controls button:hover,
        .accessibility-controls button:focus {
            border-color: #00d9ff;
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .box { padding: 2rem; border-radius: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .box h2 { font-size: 1.2rem; margin-bottom: 1.5rem; color: #00d9ff; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        input[type="text"] { 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.05); 
            color: #f5f5f5; 
            font-family: 'Titillium Web', sans-serif; 
        }
        input[type="text"]:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
            border-color: #00d9ff;
        }
        
        .colors { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .color-btn { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 2px solid transparent; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
        }
        .color-btn:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        .color-btn.active { border-color: #00d9ff; box-shadow: 0 0 10px rgba(0,217,255,0.3); }
        
        /* Enhanced drop zone for accessibility */
        .drop { 
            border: 2px dashed rgba(255,255,255,0.3); 
            border-radius: 1rem; 
            padding: 2rem; 
            text-align: center; 
            cursor: pointer;
            position: relative;
        }
        .drop:focus-within {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
            border-color: #00d9ff;
        }
        .drop.over { border-color: #00d9ff; background: rgba(0,217,255,0.1); }
        
        .file-info { 
            margin-top: 1rem; 
            padding: 0.75rem; 
            background: rgba(34,197,94,0.1); 
            border-left: 3px solid #22c55e; 
            border-radius: 0.5rem; 
            color: #bbf7d0; 
            display: none; 
        }
        
        .buttons { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        button { 
            flex: 1; 
            padding: 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-family: 'Titillium Web', sans-serif; 
            font-weight: 600; 
            cursor: pointer;
            min-width: 120px;
        }
        button:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        .btn-main { background: linear-gradient(135deg, #00d9ff, #a855f7); color: #0f0a1a; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sec { background: rgba(255,255,255,0.1); color: #f5f5f5; border: 1px solid rgba(255,255,255,0.2); }
        
        .msg { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: none; }
        .msg.show { display: block; }
        .msg.ok { background: rgba(34,197,94,0.1); border-left: 3px solid #22c55e; color: #bbf7d0; }
        .msg.err { background: rgba(239,68,68,0.1); border-left: 3px solid #ef4444; color: #fca5a5; }
        .msg.warn { background: rgba(251,191,36,0.1); border-left: 3px solid #fbbf24; color: #fde68a; }
        
        .spin { 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top: 3px solid #00d9ff; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 1rem; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .preview { 
            display: none; 
            margin-top: 2rem; 
            padding: 2rem; 
            border-radius: 1rem; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .preview.show { display: block; }
        .preview h3 { color: #00d9ff; margin-bottom: 1rem; }
        .preview iframe { 
            width: 100%; 
            height: 500px; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 0.5rem; 
            background: white; 
        }
        
        .summary-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            display: none;
        }
        .summary-panel.show { display: block; }
        .summary-panel h4 { color: #00d9ff; margin-bottom: 0.5rem; }
        .summary-panel ul { 
            list-style: none; 
            padding-left: 0; 
        }
        .summary-panel li { 
            padding: 0.25rem 0; 
            color: rgba(255,255,255,0.8);
        }
        .summary-panel .warning { color: #fbbf24; }
        .summary-panel .error { color: #ef4444; }
        .summary-panel .success { color: #22c55e; }
        
        /* Aria-live region */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        @media (max-width: 768px) { 
            .grid { grid-template-columns: 1fr; } 
            .buttons { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Aria-live region for screen reader announcements -->
    <div class="sr-only" aria-live="polite" aria-atomic="true" id="ariaLive"></div>
    
    <a href="#main" class="skip-link">Skip to main content</a>
    
    <div class="container">
        <header>
            <h1>PPTX to Scrollytelling</h1>
            <p class="subtitle">Convert your PowerPoint to a WCAG-ready scrollytelling site</p>
            
            <div class="accessibility-controls">
                <button id="contrastToggle" aria-label="Toggle high contrast mode">
                    High Contrast Mode
                </button>
            </div>
        </header>
        
        <main id="main">
        <div class="grid">
            <div class="box">
                <h2>Upload PPTX</h2>
                <label for="file" style="cursor: pointer;">
                    <div class="drop" id="drop" role="button" tabindex="0" aria-label="Upload PowerPoint file. Drag and drop or click to browse">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;" aria-hidden="true">ðŸ“¤</div>
                        <p><strong>Drag & drop PPTX here</strong></p>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 0.5rem;">or click to browse</p>
                        <input type="file" id="file" style="display: none;" accept=".pptx" aria-label="Select PowerPoint file">
                    </div>
                </label>
                <div class="file-info" id="info" role="status"></div>
                <div class="msg" id="status" role="alert"></div>
                <div class="summary-panel" id="summary">
                    <h4>Processing Summary</h4>
                    <ul id="summaryList"></ul>
                </div>
            </div>

            <div class="box">
                <h2>Customize</h2>
                <div class="form-group">
                    <label for="title">Site Title</label>
                    <input type="text" id="title" value="Driving Meaningful Health Change" aria-required="false">
                </div>
                <div class="form-group">
                    <label for="copy">Copyright</label>
                    <input type="text" id="copy" value="Â© 2026 The Gaf NYC" aria-required="false">
                </div>
                <div class="form-group">
                    <label id="themeLabel">Theme</label>
                    <div class="colors" role="radiogroup" aria-labelledby="themeLabel">
                        <button class="color-btn active" data-t="cyber" style="background: linear-gradient(135deg, #0f0a1a, #1a0a2e); color: #00d9ff;" role="radio" aria-checked="true">Cyber</button>
                        <button class="color-btn" data-t="ocean" style="background: linear-gradient(135deg, #0a1f2e, #1a3a4a); color: #00d9ff;" role="radio" aria-checked="false">Ocean</button>
                        <button class="color-btn" data-t="forest" style="background: linear-gradient(135deg, #0a2e1a, #1a4a2e); color: #22c55e;" role="radio" aria-checked="false">Forest</button>
                        <button class="color-btn" data-t="sunset" style="background: linear-gradient(135deg, #2e1a0a, #4a2e1a); color: #f97316;" role="radio" aria-checked="false">Sunset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="load" style="display: none; text-align: center; padding: 2rem;" role="status" aria-live="polite">
            <div class="spin" aria-hidden="true"></div>
            <p id="loadtxt">Processing...</p>
        </div>

        <div class="preview" id="prev">
            <h3>Preview</h3>
            <iframe id="iframe" sandbox="allow-same-origin allow-scripts" title="Preview of generated scrollytelling site"></iframe>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn-sec" id="edit" style="flex: 1;">Edit</button>
                <button class="btn-main" id="down" style="flex: 1;">Download</button>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-main" id="gen" disabled aria-describedby="genDesc">Generate Site</button>
            <button class="btn-sec" id="cancel" disabled>Cancel</button>
            <button class="btn-sec" id="reset">Reset</button>
        </div>
        <p id="genDesc" class="sr-only">Generate the scrollytelling site from your PowerPoint file</p>
        </main>
        
        <footer style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; color: rgba(255,255,255,0.5);">
            <p>PPTX to Scrollytelling Converter</p>
        </footer>
    </div>

    <script>
        // Global state
        var file = null, theme = 'cyber', html = null, zip = null, cancelled = false;
        var slideData = [];
        var summaryData = { slides: 0, images: [], warnings: [], errors: [] };
        var hasTextOverBackground = false;  // Track if text appears over background images
        
        // DOM elements
        var drop = document.getElementById('drop');
        var inp = document.getElementById('file');
        var info = document.getElementById('info');
        var status = document.getElementById('status');
        var load = document.getElementById('load');
        var prev = document.getElementById('prev');
        var gen = document.getElementById('gen');
        var down = document.getElementById('down');
        var edit = document.getElementById('edit');
        var reset = document.getElementById('reset');
        var cancelBtn = document.getElementById('cancel');
        var iframe = document.getElementById('iframe');
        var titleinp = document.getElementById('title');
        var copyinp = document.getElementById('copy');
        var contrastToggle = document.getElementById('contrastToggle');
        var ariaLive = document.getElementById('ariaLive');
        var summary = document.getElementById('summary');
        var summaryList = document.getElementById('summaryList');

        var themes = {
            cyber: {bg1: '#0f0a1a', bg2: '#1a0a2e', p: '#00d9ff', s: '#a855f7'},
            ocean: {bg1: '#0a1f2e', bg2: '#1a3a4a', p: '#00d9ff', s: '#0ea5e9'},
            forest: {bg1: '#0a2e1a', bg2: '#1a4a2e', p: '#22c55e', s: '#10b981'},
            sunset: {bg1: '#2e1a0a', bg2: '#4a2e1a', p: '#f97316', s: '#fb923c'}
        };
        
        // Bullet point detection pattern - common Unicode bullet characters
        var BULLET_PATTERN = /^[\u2022\u2023\u25E6\u2043\u2219\u00B7\u2023\u2043]/;

        // Utility functions
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function sanitizeFilename(filename) {
            return filename.replace(/[^a-zA-Z0-9._-]/g, '_');
        }

        function announceToScreenReader(message) {
            ariaLive.textContent = message;
            setTimeout(function() { ariaLive.textContent = ''; }, 1000);
        }

        function updateSummary() {
            summaryList.innerHTML = '';
            
            var items = [
                '<li class="success">Slides found: ' + summaryData.slides + '</li>'
            ];
            
            summaryData.images.forEach(function(img) {
                items.push('<li>Slide ' + img.slide + ': ' + img.count + ' image(s)</li>');
            });
            
            summaryData.warnings.forEach(function(warn) {
                items.push('<li class="warning">âš  ' + escapeHtml(warn) + '</li>');
            });
            
            summaryData.errors.forEach(function(err) {
                items.push('<li class="error">âœ— ' + escapeHtml(err) + '</li>');
            });
            
            summaryList.innerHTML = items.join('');
            summary.classList.add('show');
        }

        // High contrast toggle
        contrastToggle.addEventListener('click', function() {
            var isHighContrast = document.body.getAttribute('data-contrast') === 'high';
            if (isHighContrast) {
                document.body.removeAttribute('data-contrast');
                contrastToggle.textContent = 'High Contrast Mode';
                announceToScreenReader('High contrast mode disabled');
            } else {
                document.body.setAttribute('data-contrast', 'high');
                contrastToggle.textContent = 'Normal Contrast Mode';
                announceToScreenReader('High contrast mode enabled');
            }
        });

        // File handling
        drop.onclick = function() { inp.click(); };
        
        drop.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                inp.click();
            }
        });
        
        drop.ondragover = function(e) { 
            e.preventDefault(); 
            drop.classList.add('over'); 
        };
        
        drop.ondragleave = function() { 
            drop.classList.remove('over'); 
        };
        
        drop.ondrop = function(e) { 
            e.preventDefault(); 
            drop.classList.remove('over'); 
            handleFile(e.dataTransfer.files[0]); 
        };
        
        inp.onchange = function(e) { 
            handleFile(e.target.files[0]); 
        };

        function handleFile(f) {
            if (!f || !f.name.endsWith('.pptx')) {
                status.textContent = 'Please select a PPTX file';
                status.className = 'msg show err';
                announceToScreenReader('Error: Please select a PPTX file');
                return;
            }
            file = f;
            info.textContent = 'âœ“ ' + f.name;
            info.style.display = 'block';
            gen.disabled = false;
            status.textContent = 'Ready to process';
            status.className = 'msg show ok';
            announceToScreenReader('File loaded successfully: ' + f.name);
        }

        // Theme selection
        document.querySelectorAll('.color-btn').forEach(function(btn) {
            btn.onclick = function() {
                document.querySelectorAll('.color-btn').forEach(function(b) { 
                    b.classList.remove('active');
                    b.setAttribute('aria-checked', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-checked', 'true');
                theme = btn.dataset.t;
                announceToScreenReader('Theme changed to ' + theme);
            };
        });

        // Main generation function
        gen.onclick = function() {
            if (!file) return;
            
            cancelled = false;
            load.style.display = 'block';
            gen.disabled = true;
            cancelBtn.disabled = false;
            summaryData = { slides: 0, images: [], warnings: [], errors: [] };
            summary.classList.remove('show');
            
            announceToScreenReader('Processing PowerPoint file');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                processZip(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        };

        async function processZip(arrayBuffer) {
            try {
                var zipFile = await JSZip.loadAsync(arrayBuffer);
                zip = zipFile;
                
                if (cancelled) {
                    resetProcessing();
                    return;
                }
                
                // Validate PPTX structure
                var contentTypesFile = zipFile.file('[Content_Types].xml');
                var slideFolder = zipFile.folder('ppt/slides');
                var relsFolder = zipFile.folder('ppt/slides/_rels');
                
                if (!contentTypesFile) {
                    throw new Error('Invalid PPTX file: Missing [Content_Types].xml');
                }
                if (!slideFolder) {
                    throw new Error('Invalid PPTX file: No slides found');
                }
                
                var slideFiles = Object.keys(slideFolder.files)
                    .filter(function(f) { return f.match(/slide\d+\.xml$/); })
                    .sort(function(a, b) {
                        var matchA = a.match(/\d+/);
                        var matchB = b.match(/\d+/);
                        var numA = matchA ? parseInt(matchA[0]) : 0;
                        var numB = matchB ? parseInt(matchB[0]) : 0;
                        return numA - numB;
                    });
                
                if (slideFiles.length === 0) {
                    throw new Error('Invalid PPTX file: No slide content found');
                }
                
                summaryData.slides = slideFiles.length;
                document.getElementById('loadtxt').textContent = 'Processing ' + slideFiles.length + ' slides...';
                
                slideData = [];
                
                for (var i = 0; i < slideFiles.length; i++) {
                    if (cancelled) {
                        resetProcessing();
                        return;
                    }
                    
                    var slideNum = i + 1;
                    document.getElementById('loadtxt').textContent = 'Processing slide ' + slideNum + ' of ' + slideFiles.length + '...';
                    
                    var slideXml = await slideFolder.file(slideFiles[i]).async('string');
                    var slideImages = await getSlideImages(zipFile, slideNum, slideXml);
                    var slideText = parseSlideText(slideXml);
                    
                    summaryData.images.push({ slide: slideNum, count: slideImages.length });
                    
                    slideData.push({
                        num: slideNum,
                        text: slideText,
                        images: slideImages
                    });
                }
                
                if (cancelled) {
                    resetProcessing();
                    return;
                }
                
                html = await makeHTML(slideData);
                
                iframe.srcdoc = html;
                prev.classList.add('show');
                load.style.display = 'none';
                gen.disabled = false;
                cancelBtn.disabled = true;
                status.textContent = 'Site generated successfully';
                status.className = 'msg show ok';
                announceToScreenReader('Site generated successfully. Preview is ready.');
                
                updateSummary();
                
            } catch (e) {
                summaryData.errors.push(e.message);
                status.textContent = 'Error: ' + e.message;
                status.className = 'msg show err';
                load.style.display = 'none';
                gen.disabled = false;
                cancelBtn.disabled = true;
                announceToScreenReader('Error: ' + e.message);
                updateSummary();
            }
        }

        async function getSlideImages(zipFile, slideNum, slideXml) {
            var images = [];
            
            try {
                // Parse slide XML to find image references (r:embed or r:id attributes)
                var slideParser = new DOMParser();
                var slideDoc = slideParser.parseFromString(slideXml, 'text/xml');
                
                // Find all image references in the slide
                var picElements = slideDoc.getElementsByTagName('p:pic');
                var imageRefs = [];
                
                for (var i = 0; i < picElements.length; i++) {
                    var blipElements = picElements[i].getElementsByTagName('a:blip');
                    for (var j = 0; j < blipElements.length; j++) {
                        var embedAttr = blipElements[j].getAttribute('r:embed') || blipElements[j].getAttribute('r:link');
                        if (embedAttr) {
                            imageRefs.push(embedAttr);
                        }
                    }
                }
                
                // Load relationship file
                var relsPath = 'ppt/slides/_rels/slide' + slideNum + '.xml.rels';
                var relsFile = zipFile.file(relsPath);
                
                if (!relsFile) {
                    // No relationships file - no images
                    if (imageRefs.length > 0) {
                        summaryData.warnings.push('Slide ' + slideNum + ': Found image references but no relationships file');
                    }
                    return images;
                }
                
                var relsXml = await relsFile.async('string');
                var relsParser = new DOMParser();
                var relsDoc = relsParser.parseFromString(relsXml, 'text/xml');
                
                // Build a map of relationship IDs to image targets
                var relationships = relsDoc.querySelectorAll('Relationship');
                var relMap = {};
                
                for (var i = 0; i < relationships.length; i++) {
                    var rel = relationships[i];
                    var relId = rel.getAttribute('Id');
                    var type = rel.getAttribute('Type');
                    var target = rel.getAttribute('Target');
                    
                    if (type && type.includes('image') && target && relId) {
                        relMap[relId] = target;
                    }
                }
                
                // Match image references to actual files
                for (var i = 0; i < imageRefs.length; i++) {
                    var refId = imageRefs[i];
                    var target = relMap[refId];
                    
                    if (!target) {
                        summaryData.warnings.push('Slide ' + slideNum + ': Could not resolve image reference ' + refId);
                        continue;
                    }
                    
                    // Resolve path: targets are relative to ppt/slides/
                    // If target starts with ../,  resolve against ppt/
                    var imagePath;
                    if (target.startsWith('../')) {
                        // Remove ../ and prepend ppt/
                        imagePath = 'ppt/' + target.substring(3);
                    } else {
                        // Relative to ppt/slides/
                        imagePath = 'ppt/slides/' + target;
                    }
                    
                    var imageFile = zipFile.file(imagePath);
                    
                    if (imageFile) {
                        var imageData = await imageFile.async('base64');
                        var ext = imagePath.split('.').pop().toLowerCase();
                        
                        // Validate and map file extensions to MIME types
                        var mimeTypeMap = {
                            'jpg': 'image/jpeg',
                            'jpeg': 'image/jpeg',
                            'png': 'image/png',
                            'gif': 'image/gif',
                            'svg': 'image/svg+xml',
                            'bmp': 'image/bmp',
                            'webp': 'image/webp'
                        };
                        
                        var mimeType = mimeTypeMap[ext];
                        if (!mimeType) {
                            summaryData.warnings.push('Unknown image format: ' + ext + ' in slide ' + slideNum);
                            mimeType = 'image/png'; // Default fallback
                        }
                        
                        images.push({
                            data: 'data:' + mimeType + ';base64,' + imageData,
                            rId: refId,
                            isBackground: i === 0  // First referenced image becomes background
                        });
                    } else {
                        summaryData.warnings.push('Slide ' + slideNum + ': Image file not found: ' + imagePath);
                    }
                }
                
                // Add note if no images were resolved
                if (imageRefs.length > 0 && images.length === 0) {
                    summaryData.warnings.push('Slide ' + slideNum + ': Could not load any images despite ' + imageRefs.length + ' reference(s)');
                }
                
            } catch (e) {
                summaryData.warnings.push('Could not load images for slide ' + slideNum + ': ' + e.message);
            }
            
            return images;
        }

        function parseSlideText(xml) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xml, 'text/xml');
            
            // Get all paragraph elements (a:p or p)
            var aParagraphs = doc.getElementsByTagName('a:p');
            var plainParagraphs = doc.getElementsByTagName('p');
            
            var paragraphs = [];
            
            // Process a:p elements
            for (var i = 0; i < aParagraphs.length; i++) {
                var para = aParagraphs[i];
                
                // Check if paragraph has bullet properties
                var hasBullet = false;
                var pPrElements = para.getElementsByTagName('a:pPr');
                
                if (pPrElements.length > 0) {
                    var pPr = pPrElements[0];
                    // Check for bullet character (a:buChar) or auto-numbering (a:buAutoNum)
                    var buChar = pPr.getElementsByTagName('a:buChar');
                    var buAutoNum = pPr.getElementsByTagName('a:buAutoNum');
                    var buNone = pPr.getElementsByTagName('a:buNone');
                    
                    // Has bullet if buChar or buAutoNum present, and buNone not present
                    if ((buChar.length > 0 || buAutoNum.length > 0) && buNone.length === 0) {
                        hasBullet = true;
                    }
                }
                
                // Extract text from paragraph
                var textElements = para.getElementsByTagName('a:t');
                var paraText = '';
                for (var j = 0; j < textElements.length; j++) {
                    paraText += textElements[j].textContent;
                }
                
                paraText = paraText.trim();
                if (paraText) {
                    paragraphs.push({
                        text: paraText,
                        isBullet: hasBullet
                    });
                }
            }
            
            // Process plain p elements if no a:p found
            if (paragraphs.length === 0) {
                for (var i = 0; i < plainParagraphs.length; i++) {
                    var para = plainParagraphs[i];
                    var textElements = para.getElementsByTagName('t');
                    var paraText = '';
                    for (var j = 0; j < textElements.length; j++) {
                        paraText += textElements[j].textContent;
                    }
                    
                    paraText = paraText.trim();
                    if (paraText) {
                        // Fallback: detect bullets by Unicode characters
                        var hasBullet = BULLET_PATTERN.test(paraText);
                        paragraphs.push({
                            text: paraText,
                            isBullet: hasBullet
                        });
                    }
                }
            }
            
            var result = {
                heading: '',
                content: []
            };
            
            // First non-bullet paragraph becomes heading
            for (var i = 0; i < paragraphs.length; i++) {
                if (!paragraphs[i].isBullet && paragraphs[i].text) {
                    result.heading = paragraphs[i].text;
                    // Rest becomes content
                    for (var j = i + 1; j < paragraphs.length; j++) {
                        result.content.push(paragraphs[j]);
                    }
                    break;
                }
            }
            
            // If all paragraphs are bullets or no heading found, use first as heading
            if (!result.heading && paragraphs.length > 0) {
                result.heading = paragraphs[0].text;
                for (var i = 1; i < paragraphs.length; i++) {
                    result.content.push(paragraphs[i]);
                }
            }
            
            return result;
        }

        async function makeHTML(slides) {
            var t = themes[theme];
            var secs = '';
            
            for (var i = 0; i < slides.length; i++) {
                var slide = slides[i];
                var bgStyle = '';
                var inlineImages = '';
                
                if (slide.images.length > 0) {
                    var bgImage = slide.images.find(function(img) { return img.isBackground; }) || slide.images[0];
                    bgStyle = 'background-image: url(' + bgImage.data + '); background-size: cover; background-position: center;';
                    
                    var additionalImages = slide.images.slice(1);
                    additionalImages.forEach(function(img, idx) {
                        // Generate descriptive alt text based on slide content
                        var altText = '';
                        if (slide.text.heading) {
                            altText = 'Supporting image for ' + escapeHtml(slide.text.heading);
                            if (additionalImages.length > 1) {
                                altText += ' (image ' + (idx + 1) + ' of ' + additionalImages.length + ')';
                            }
                        } else {
                            altText = 'Image ' + (idx + 1) + ' from slide ' + (i + 1);
                        }
                        inlineImages += '<img src="' + img.data + '" alt="' + altText + '" loading="lazy" style="max-width: 100%; height: auto; margin: 1rem 0; border-radius: 0.5rem;">';
                    });
                }
                
                var heading = slide.text.heading ? '<h2>' + escapeHtml(slide.text.heading) + '</h2>' : '';
                var content = '';
                
                // Generate stable ID for heading and aria-labelledby for section
                var slideId = 'slide-' + (i + 1) + '-title';
                var ariaLabel = '';
                if (slide.text.heading) {
                    heading = '<h2 id="' + slideId + '">' + escapeHtml(slide.text.heading) + '</h2>';
                    ariaLabel = ' aria-labelledby="' + slideId + '"';
                }
                
                if (slide.text.content.length > 0) {
                    var bullets = [];
                    var paras = [];
                    
                    slide.text.content.forEach(function(item) {
                        if (item.isBullet) {
                            // Remove bullet character and extra whitespace
                            var cleanText = item.text.replace(BULLET_PATTERN, '').replace(/^\s+/, '');
                            bullets.push('<li>' + escapeHtml(cleanText) + '</li>');
                        } else {
                            if (bullets.length > 0) {
                                content += '<ul>' + bullets.join('') + '</ul>';
                                bullets = [];
                            }
                            content += '<p>' + escapeHtml(item.text) + '</p>';
                        }
                    });
                    
                    if (bullets.length > 0) {
                        content += '<ul>' + bullets.join('') + '</ul>';
                    }
                }
                
                // Build section with aria-labelledby if heading exists
                secs += '<section' + ariaLabel + ' style="' + bgStyle + '"><div class="ov"></div><div class="con">' + heading + content + inlineImages + '</div></section>';
            }

            // Check if any slides have text over background images
            hasTextOverBackground = false;  // Reset global state
            for (var i = 0; i < slides.length; i++) {
                if (slides[i].images.length > 0 && (slides[i].text.heading || slides[i].text.content.length > 0)) {
                    hasTextOverBackground = true;
                    break;
                }
            }

            var reducedMotionCSS = '@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }';
            
            var skipLinkCSS = '.skip-link{position:absolute;top:-40px;left:0;background:#fff;color:#000;padding:8px 16px;text-decoration:none;z-index:10000;font-weight:600;border:2px solid #000}.skip-link:focus{top:0;outline:2px solid #00d9ff;outline-offset:2px}';
            
            var focusStylesCSS = 'button:focus,a:focus,.contrast-toggle:focus{outline:2px solid #00d9ff;outline-offset:2px}';
            
            var css = '*{margin:0;padding:0;box-sizing:border-box}' + skipLinkCSS + focusStylesCSS + ':root{--p:' + t.p + ';--s:' + t.s + ';--b1:' + t.bg1 + ';--b2:' + t.bg2 + '}html{scroll-behavior:smooth}body{font-family:Titillium Web,sans-serif;background:linear-gradient(135deg,var(--b1),var(--b2));color:#f5f5f5;line-height:1.6}body[data-contrast="high"]{background:#000;color:#fff;}.pb{position:fixed;top:0;left:0;height:4px;background:linear-gradient(90deg,var(--p),var(--s));z-index:1000;width:0;transition:width 0.3s}section{min-height:auto;display:flex;align-items:center;position:relative;overflow:hidden;padding:72px 0}@media(min-width:1024px){section{min-height:100vh;padding:0}}.con{max-width:1200px;margin:0 auto;padding:2rem;width:100%;position:relative;z-index:10}h1{font-size:clamp(2.5rem,8vw,5rem);font-weight:700;margin-bottom:1.5rem;background:linear-gradient(135deg,var(--p),#fff,var(--s));-webkit-background-clip:text;-webkit-text-fill-color:transparent}h2{font-size:clamp(2rem,5vw,3.5rem);font-weight:700;margin-bottom:2rem}p{font-size:1.1rem;color:rgba(255,255,255,0.8);margin-bottom:1rem}ul{margin-left:2rem;margin-bottom:1rem}li{margin-bottom:0.5rem;color:rgba(255,255,255,0.8)}.ov{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(26,10,46,0.8),rgba(26,10,46,0.6));z-index:2}#hero{background:linear-gradient(135deg,var(--b1),var(--b2))}.hc{text-align:center;animation:fadeIn 1s}@keyframes fadeIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}footer{padding:2rem;border-top:1px solid rgba(255,255,255,0.1);text-align:center;color:rgba(255,255,255,0.5)}.contrast-toggle{position:fixed;top:1rem;right:1rem;padding:0.5rem 1rem;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);color:#f5f5f5;cursor:pointer;border-radius:0.5rem;z-index:1001;font-family:inherit;font-weight:600}body[data-contrast="high"] .contrast-toggle{background:#fff;color:#000;border-color:#fff}' + reducedMotionCSS;

            var accessibilityReport = generateAccessibilityReport(slides, hasTextOverBackground);
            
            var result = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>' + escapeHtml(titleinp.value) + '</title><link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet"><style>' + css + '</style></head><body><a href="#main" class="skip-link">Skip to main content</a><button class="contrast-toggle" id="contrastBtn" aria-label="Toggle high contrast mode">High Contrast</button><div class="pb" id="pb"></div><header id="hero"><div class="ov"></div><div class="con"><div class="hc"><h1>' + escapeHtml(titleinp.value) + '</h1><p style="font-size:1.3rem;color:rgba(255,255,255,0.6)">Scroll to explore</p></div></div></header><main id="main">' + secs + '</main><footer><p>' + escapeHtml(copyinp.value) + '</p></footer><script>window.addEventListener("scroll",function(){var t=window.scrollY,h=document.documentElement.scrollHeight-window.innerHeight;document.getElementById("pb").style.width=(t/h*100)+"%"});document.getElementById("contrastBtn").addEventListener("click",function(){var isHigh=document.body.getAttribute("data-contrast")==="high";if(isHigh){document.body.removeAttribute("data-contrast");this.textContent="High Contrast";}else{document.body.setAttribute("data-contrast","high");this.textContent="Normal Contrast";}});<\/script></body></html>';

            return result;
        }

        function generateAccessibilityReport(slides, hasTextOverBackground) {
            var report = [];
            report.push('ACCESSIBILITY REPORT');
            report.push('Generated: ' + new Date().toISOString());
            report.push('');
            report.push('=== IMPORTANT NOTES ===');
            report.push('This report covers the TECHNICAL accessibility features of the generated site.');
            report.push('WCAG compliance also depends on source content quality (e.g., meaningful');
            report.push('headings, sufficient color contrast, appropriate image usage).');
            report.push('');
            report.push('=== CONTENT SUMMARY ===');
            report.push('Total slides: ' + slides.length);
            
            var totalImages = 0;
            var imagesWithAlt = 0;
            var backgroundImages = 0;
            var inlineImages = 0;
            
            slides.forEach(function(slide) {
                if (slide.images.length > 0) {
                    totalImages += slide.images.length;
                    backgroundImages += 1; // First image is background
                    inlineImages += Math.max(0, slide.images.length - 1);
                    // Only inline images have alt text
                    imagesWithAlt += Math.max(0, slide.images.length - 1);
                }
            });
            
            report.push('Total images: ' + totalImages);
            report.push('Background images: ' + backgroundImages + ' (CSS decorative)');
            report.push('Inline images: ' + inlineImages);
            report.push('Images with alt text: ' + imagesWithAlt + ' (all inline images)');
            report.push('');
            report.push('=== WCAG-READY FEATURES ===');
            report.push('[âœ“] Skip link ("Skip to main content") for keyboard navigation');
            report.push('[âœ“] Semantic HTML structure (header, main, footer)');
            report.push('[âœ“] High contrast toggle button');
            report.push('[âœ“] Respects prefers-reduced-motion (disables animations)');
            report.push('[âœ“] Visible focus indicators on interactive elements');
            report.push('[âœ“] All inline images have descriptive alt text');
            report.push('[âœ“] Lazy loading enabled for images');
            report.push('[âœ“] Keyboard accessible (all functionality via keyboard)');
            report.push('[âœ“] ARIA labels on interactive controls');
            report.push('');
            report.push('=== BACKGROUND IMAGES (CSS) ===');
            report.push('Background images are implemented as CSS background-image properties.');
            report.push('Per WCAG guidelines, these are treated as DECORATIVE and do not require');
            report.push('alt text. All MEANINGFUL images must be inline <img> elements.');
            report.push('');
            if (hasTextOverBackground) {
                report.push('âš  WARNING: Text content is placed over background images.');
                report.push('  Ensure sufficient contrast between text and background.');
                report.push('  Test with high contrast mode and verify readability.');
                report.push('');
            }
            report.push('=== CONTENT-DEPENDENT COMPLIANCE ===');
            report.push('The following require manual verification:');
            report.push('- Color contrast ratios (text vs background)');
            report.push('- Heading structure and hierarchy');
            report.push('- Link text meaningfulness');
            report.push('- Image alt text accuracy and completeness');
            report.push('- Content readability and clarity');
            report.push('');
            report.push('=== LIMITATIONS DOCUMENTED ===');
            report.push('1. Image-to-slide mapping: Uses r:embed references from slide XML.');
            report.push('   Order is based on appearance in slide XML, which may differ from');
            report.push('   visual stacking order. First referenced image becomes background.');
            report.push('');
            report.push('2. Bullet detection: Uses paragraph properties (a:pPr, a:buChar,');
            report.push('   a:buAutoNum) when available. Falls back to Unicode bullet character');
            report.push('   detection for plain text paragraphs.');
            report.push('');
            report.push('3. Background images: Cannot guarantee text contrast over backgrounds.');
            report.push('   Manual review recommended for slides with text over images.');
            report.push('');
            report.push('=== RECOMMENDATIONS ===');
            report.push('- Test with screen readers (NVDA, JAWS, VoiceOver)');
            report.push('- Verify keyboard navigation works for all content');
            report.push('- Check color contrast with tools like WebAIM Contrast Checker');
            report.push('- Test with high contrast mode enabled');
            report.push('- Review with prefers-reduced-motion enabled');
            report.push('- Validate with automated tools (axe, WAVE, Lighthouse)');
            report.push('');
            report.push('This converter generates WCAG-READY output with proper structure,');
            report.push('semantics, and accessibility features. Final compliance depends on');
            report.push('source content quality and manual verification.');
            
            if (summaryData.warnings.length > 0) {
                report.push('');
                report.push('=== PROCESSING WARNINGS ===');
                summaryData.warnings.forEach(function(w) {
                    report.push('- ' + w);
                });
            }
            
            return report.join('\n');
        }

        // Download functionality
        down.onclick = async function() {
            if (!zip || !html) return;
            
            down.disabled = true;
            announceToScreenReader('Preparing download...');
            
            try {
                var outputZip = new JSZip();
                
                // Add index.html
                outputZip.file('index.html', html);
                
                // Generate accessibility report with correct arguments
                var accessibilityReport = generateAccessibilityReport(slideData, hasTextOverBackground);
                outputZip.file('ACCESSIBILITY_REPORT.txt', accessibilityReport);
                
                // Generate the zip
                var blob = await outputZip.generateAsync({type: 'blob'});
                
                // Create user-friendly filename with date
                var now = new Date();
                var dateStr = now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0');
                var filename = sanitizeFilename('scrollytelling-' + dateStr + '.zip');
                
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                down.disabled = false;
                announceToScreenReader('Download complete');
                
            } catch (e) {
                status.textContent = 'Download error: ' + e.message;
                status.className = 'msg show err';
                down.disabled = false;
                announceToScreenReader('Download failed');
            }
        };

        // Cancel button
        cancelBtn.onclick = function() {
            cancelled = true;
            cancelBtn.disabled = true;
            announceToScreenReader('Processing cancelled');
            resetProcessing();
        };

        function resetProcessing() {
            load.style.display = 'none';
            gen.disabled = false;
            cancelBtn.disabled = true;
            status.textContent = 'Processing cancelled';
            status.className = 'msg show warn';
        }

        // Edit button
        edit.onclick = function() {
            prev.classList.remove('show');
            gen.disabled = false;
            announceToScreenReader('Returned to edit mode');
        };

        // Reset button
        reset.onclick = function() {
            file = null;
            inp.value = '';
            info.style.display = 'none';
            gen.disabled = true;
            cancelBtn.disabled = true;
            status.classList.remove('show');
            prev.classList.remove('show');
            summary.classList.remove('show');
            titleinp.value = 'Driving Meaningful Health Change';
            copyinp.value = 'Â© 2026 The Gaf NYC';
            theme = 'cyber';
            slideData = [];
            summaryData = { slides: 0, images: [], warnings: [], errors: [] };
            
            document.querySelectorAll('.color-btn').forEach(function(b) { 
                b.classList.remove('active');
                b.setAttribute('aria-checked', 'false');
            });
            document.querySelectorAll('.color-btn')[0].classList.add('active');
            document.querySelectorAll('.color-btn')[0].setAttribute('aria-checked', 'true');
            
            announceToScreenReader('Form reset');
        };
    </script>
</body>
</html>
