<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PPTX to Scrollytelling - Convert PowerPoint to bespoke scrollytelling sites">
    <title>PPTX to Scrollytelling Converter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: #1a1a1a;
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
        }
        .skip-link { position: absolute; top: -40px; left: 0; background: #000; color: #fff; padding: 8px; z-index: 100; }
        .skip-link:focus { top: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 3rem; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #1a1a1a; }
        .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 2rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .box { padding: 2rem; border-radius: 0.75rem; background: #fff; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .box h2 { font-size: 1.2rem; margin-bottom: 1.5rem; color: #1a1a1a; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem; color: #333; }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #ddd;
            background: #fff;
            color: #1a1a1a;
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="file"]:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1); }
        .drop-zone { border: 2px dashed #999; border-radius: 0.75rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
        .drop-zone:hover { border-color: #0066cc; background: #f0f5ff; }
        .drop-zone.over { border-color: #0066cc; background: #e6f0ff; }
        .drop-zone p { margin: 0.5rem 0; color: #666; }
        input[type="file"] { display: none; }
        .file-info, .msg { margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; border-left: 4px solid; display: none; font-size: 0.9rem; }
        .file-info.show, .msg.show { display: block; }
        .file-info { background: #e6f9e6; border-color: #22c55e; color: #166534; }
        .msg.ok { background: #e6f9e6; border-color: #22c55e; color: #166534; }
        .msg.err { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .msg.warn { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .msg.info { background: #dbeafe; border-color: #3b82f6; color: #1e40af; }
        .buttons { display: flex; gap: 1rem; margin-top: 2rem; }
        button { flex: 1; padding: 1rem; border: none; border-radius: 0.5rem; font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        button:focus { outline: 2px solid #0066cc; outline-offset: 2px; }
        .btn-main { background: #0066cc; color: #fff; }
        .btn-main:hover:not(:disabled) { background: #0052a3; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sec { background: #f0f0f0; color: #1a1a1a; border: 1px solid #ddd; }
        .btn-sec:hover { background: #e8e8e8; }
        .loading { display: none; text-align: center; padding: 2rem; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f0f0f0; border-top: 4px solid #0066cc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .summary { padding: 1rem; background: #f0f5ff; border-radius: 0.5rem; border-left: 4px solid #3b82f6; margin-top: 1rem; display: none; }
        .summary.show { display: block; }
        .summary h3 { color: #1e40af; margin-bottom: 0.5rem; font-size: 1rem; }
        .summary-item { font-size: 0.9rem; margin-bottom: 0.25rem; color: #1e40af; }
        .preview { display: none; margin-top: 2rem; padding: 2rem; background: #fff; border-radius: 0.75rem; border: 1px solid #ddd; }
        .preview.show { display: block; }
        .preview h3 { margin-bottom: 1rem; color: #1a1a1a; }
        .preview-iframe { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 0.5rem; background: #fff; }
        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } h1 { font-size: 1.8rem; } .preview-iframe { height: 400px; } }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Skip to main content</a>

    <div class="container">
        <header>
            <h1>PPTX to Scrollytelling</h1>
            <p class="subtitle">Transform your PowerPoint presentations into bespoke, responsive scrollytelling websites. Each conversion is unique to your deck's design.</p>
        </header>

        <main id="main">
            <div class="grid">
                <div class="box">
                    <h2>Upload PPTX</h2>
                    <div class="drop-zone" id="dropZone" role="button" tabindex="0" aria-label="Drop PPTX file here or click to browse">
                        <p style="font-size: 2rem; margin-bottom: 0.5rem;">üì§</p>
                        <p><strong>Drag & drop PPTX here</strong></p>
                        <p style="color: #999; font-size: 0.9rem;">or click to browse</p>
                        <input type="file" id="fileInput" accept=".pptx" aria-label="Select PPTX file">
                    </div>
                    <div class="file-info" id="fileInfo"></div>
                    <div class="msg" id="uploadStatus" role="status" aria-live="polite" aria-atomic="true"></div>
                </div>

                <div class="box">
                    <h2>Design Analysis</h2>
                    <div class="summary" id="summary" role="region" aria-label="Design analysis">
                        <div id="summaryContent"></div>
                    </div>
                    <div style="padding: 1rem; background: #f0f5ff; border-radius: 0.5rem; border-left: 4px solid #3b82f6; color: #1e40af; font-size: 0.9rem; margin-top: 1rem;">
                        <strong>‚ú® Bespoke Design:</strong> The converter analyzes your deck's unique fonts, colors, layouts, and visual hierarchy to create a custom scrollytelling site.
                    </div>
                </div>
            </div>

            <div id="loading" class="loading" role="status" aria-live="polite" aria-atomic="true">
                <div class="spinner"></div>
                <p id="loadingText">Analyzing your presentation...</p>
            </div>

            <div class="preview" id="preview" role="region" aria-label="Generated site preview">
                <h3>Preview</h3>
                <iframe id="previewIframe" class="preview-iframe" title="Preview of generated scrollytelling site" sandbox="allow-same-origin"></iframe>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn-sec" id="editBtn">‚Üê Edit & Regenerate</button>
                    <button class="btn-main" id="downloadBtn">‚úì Download ZIP</button>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-main" id="generateBtn" disabled aria-label="Generate preview from uploaded PPTX">Generate Preview</button>
                <button class="btn-sec" id="resetBtn" aria-label="Reset form and clear all inputs">Reset</button>
            </div>
        </main>
    </div>

    <script>
        var selectedFile = null;
        var extractedData = null;
        var generatedHTML = null;
        var generatedZip = null;
        var processingLog = [];

        var dropZone = document.getElementById('dropZone');
        var fileInput = document.getElementById('fileInput');
        var fileInfo = document.getElementById('fileInfo');
        var uploadStatus = document.getElementById('uploadStatus');
        var summary = document.getElementById('summary');
        var summaryContent = document.getElementById('summaryContent');
        var loading = document.getElementById('loading');
        var loadingText = document.getElementById('loadingText');
        var preview = document.getElementById('preview');
        var previewIframe = document.getElementById('previewIframe');
        var generateBtn = document.getElementById('generateBtn');
        var downloadBtn = document.getElementById('downloadBtn');
        var editBtn = document.getElementById('editBtn');
        var resetBtn = document.getElementById('resetBtn');

        var fontMappings = {
            'titillium': 'Titillium Web',
            'inter': 'Inter',
            'roboto': 'Roboto',
            'montserrat': 'Montserrat',
            'merriweather': 'Merriweather',
            'plex': 'IBM Plex Mono',
            'source': 'Source Sans 3',
            'lato': 'Lato',
            'open': 'Open Sans',
            'poppins': 'Poppins',
            'raleway': 'Raleway',
            'ubuntu': 'Ubuntu',
            'helvetica': 'Helvetica Neue',
            'arial': 'Arial',
            'georgia': 'Georgia',
            'times': 'Times New Roman'
        };

        dropZone.addEventListener('click', function() { fileInput.click(); });
        dropZone.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });
        dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('over'); });
        dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('over'); });
        dropZone.addEventListener('drop', function(e) { e.preventDefault(); dropZone.classList.remove('over'); handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', function(e) { handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (!file) return;
            if (!file.name.endsWith('.pptx')) {
                showStatus('Please select a valid PPTX file.', 'err');
                return;
            }
            selectedFile = file;
            fileInfo.textContent = '‚úì ' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)';
            fileInfo.classList.add('show');
            generateBtn.disabled = false;
            showStatus('File ready to process!', 'ok');
        }

        function showStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = 'msg show ' + type;
        }

        function addLog(message, type) {
            processingLog.push({ message: message, type: type || 'info' });
            console.log('[' + type.toUpperCase() + '] ' + message);
        }

        function updateSummary() {
            var html = '<h3>Design Analysis</h3>';
            for (var i = 0; i < processingLog.length; i++) {
                var log = processingLog[i];
                var prefix = log.type === 'warn' ? '‚ö†Ô∏è' : log.type === 'err' ? '‚ùå' : '‚úì';
                html += '<div class="summary-item">' + prefix + ' ' + log.message + '</div>';
            }
            summaryContent.innerHTML = html;
            summary.classList.add('show');
        }

        function escapeHtml(text) {
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function mapFont(fontName) {
            if (!fontName) return 'Inter';
            var lower = fontName.toLowerCase();
            for (var key in fontMappings) {
                if (lower.includes(key)) return fontMappings[key];
            }
            return 'Inter';
        }

        function extractPPTXData(pptxZip) {
            var data = {
                fonts: { primary: 'Inter', secondary: 'Inter' },
                colors: { primary: '#0076BA', secondary: '#05A89D', background: '#ffffff', foreground: '#1a1a1a', accent: '#F9B900' },
                slides: [],
                images: [],
                colorPalette: [],
                designStyle: 'modern'
            };

            try {
                var themeFile = pptxZip.file('ppt/theme/theme1.xml');
                if (themeFile) {
                    var themeXml = themeFile.asText();
                    
                    var majorFontMatch = themeXml.match(/<a:majorFont><a:latin typeface="([^"]+)"/);
                    var minorFontMatch = themeXml.match(/<a:minorFont><a:latin typeface="([^"]+)"/);
                    if (majorFontMatch) data.fonts.primary = mapFont(majorFontMatch[1]);
                    if (minorFontMatch) data.fonts.secondary = mapFont(minorFontMatch[1]);
                    
                    var accent1Match = themeXml.match(/<a:accent1><a:srgbClr val="([0-9A-Fa-f]{6})"/);
                    var accent2Match = themeXml.match(/<a:accent2><a:srgbClr val="([0-9A-Fa-f]{6})"/);
                    var accent3Match = themeXml.match(/<a:accent3><a:srgbClr val="([0-9A-Fa-f]{6})"/);
                    var accent4Match = themeXml.match(/<a:accent4><a:srgbClr val="([0-9A-Fa-f]{6})"/);
                    
                    if (accent1Match) data.colors.primary = '#' + accent1Match[1];
                    if (accent2Match) data.colors.secondary = '#' + accent2Match[1];
                    if (accent3Match) data.colorPalette.push('#' + accent3Match[1]);
                    if (accent4Match) { data.colors.accent = '#' + accent4Match[1]; data.colorPalette.push('#' + accent4Match[1]); }
                    
                    addLog('Fonts: ' + data.fonts.primary + ' (primary), ' + data.fonts.secondary + ' (secondary)', 'info');
                    addLog('Colors: ' + data.colors.primary + ', ' + data.colors.secondary, 'info');
                } else {
                    addLog('No theme file found, using defaults', 'warn');
                }
            } catch (e) {
                addLog('Error parsing theme: ' + e.message, 'warn');
            }

            try {
                var slideFolder = pptxZip.folder('ppt/slides');
                if (slideFolder) {
                    var slideFiles = [];
                    slideFolder.forEach(function(path, file) {
                        if (path.match(/slide\d+\.xml$/) && !path.includes('_rels')) {
                            slideFiles.push(path);
                        }
                    });
                    slideFiles.sort();

                    for (var i = 0; i < slideFiles.length; i++) {
                        var slideFile = slideFiles[i];
                        var xmlContent = slideFolder.file(slideFile).asText();
                        
                        var textNodes = xmlContent.match(/<a:t>([^<]+)<\/a:t>/g) || [];
                        var text = '';
                        for (var j = 0; j < textNodes.length; j++) {
                            text += textNodes[j].replace(/<a:t>|<\/a:t>/g, '') + ' ';
                        }
                        
                        var hasImage = xmlContent.includes('blip') || xmlContent.includes('image');
                        var hasBackground = xmlContent.includes('solidFill') || xmlContent.includes('gradFill');
                        var textLength = text.trim().length;
                        var lineCount = text.split('\n').length;
                        
                        var layout = 'content';
                        if (i === 0) layout = 'hero';
                        else if (hasImage && textLength < 100) layout = 'image-focus';
                        else if (lineCount > 5) layout = 'list';
                        else if (textLength > 300) layout = 'text-heavy';
                        
                        data.slides.push({
                            number: i + 1,
                            text: text.trim(),
                            layout: layout,
                            hasImage: hasImage,
                            hasBackground: hasBackground,
                            textLength: textLength
                        });
                    }
                    addLog('Analyzed ' + data.slides.length + ' slides with design detection', 'info');
                } else {
                    addLog('No slides found', 'err');
                }
            } catch (e) {
                addLog('Error parsing slides: ' + e.message, 'err');
            }

            try {
                var mediaFolder = pptxZip.folder('ppt/media');
                if (mediaFolder) {
                    var imageCount = 0;
                    mediaFolder.forEach(function(path, file) {
                        if (path.includes('.emf') || path.includes('.wmf')) {
                            addLog('Skipped EMF/WMF: ' + path, 'warn');
                        } else if (path.match(/\.(jpg|jpeg|png|gif)$/i)) {
                            file.async('arraybuffer').then(function(data) {
                                data.images.push({ path: path, data: data });
                            });
                            imageCount++;
                        }
                    });
                    if (imageCount > 0) addLog('Extracted ' + imageCount + ' images', 'info');
                }
            } catch (e) {
                addLog('Error extracting images: ' + e.message, 'warn');
            }

            return data;
        }

        function generateBespokeHTML(data) {
            var sections = '';
            var colorIndex = 0;
            
            for (var i = 0; i < data.slides.length; i++) {
                var slide = data.slides[i];
                var bgColor = i % 2 === 0 ? data.colors.background : '#f8f9fa';
                var textColor = i % 2 === 0 ? data.colors.foreground : data.colors.primary;
                var accentColor = data.colorPalette[colorIndex % data.colorPalette.length] || data.colors.secondary;
                colorIndex++;
                
                var heading = slide.text.split('\n')[0] || 'Section ' + (i + 1);
                var body = slide.text.substring(heading.length).trim();
                
                if (slide.layout === 'hero') {
                    sections += '<section class="hero" style="background:linear-gradient(135deg,' + data.colors.primary + ',#' + (parseInt(data.colors.primary.substring(1), 16) + 0x333333).toString(16).substring(0, 6) + ');color:#fff"><div class="section-content"><h1>' + escapeHtml(heading) + '</h1><p style="font-size:1.2rem;opacity:0.9">' + escapeHtml(body.substring(0, 100)) + '</p></div></section>';
                } else if (slide.layout === 'image-focus') {
                    sections += '<section class="image-focus" style="background:' + bgColor + ';border-left:6px solid ' + accentColor + '"><div class="section-content"><h2 style="color:' + data.colors.primary + '">' + escapeHtml(heading) + '</h2><p style="color:' + textColor + ';margin-top:1rem">' + escapeHtml(body.substring(0, 150)) + '</p></div></section>';
                } else if (slide.layout === 'list') {
                    var bullets = body.split('\n').filter(function(l) { return l.trim(); });
                    var listHtml = '<section class="list" style="background:' + bgColor + '"><div class="section-content"><h2 style="color:' + data.colors.primary + ';border-bottom:3px solid ' + accentColor + ';padding-bottom:1rem">' + escapeHtml(heading) + '</h2><ul style="margin-left:2rem;margin-top:1.5rem">';
                    for (var j = 0; j < Math.min(bullets.length, 5); j++) {
                        listHtml += '<li style="margin-bottom:0.75rem;color:' + textColor + '"><span style="color:' + accentColor + ';font-weight:700">‚Ä¢</span> ' + escapeHtml(bullets[j]) + '</li>';
                    }
                    listHtml += '</ul></div></section>';
                    sections += listHtml;
                } else if (slide.layout === 'text-heavy') {
                    sections += '<section class="text-heavy" style="background:' + bgColor + '"><div class="section-content"><h2 style="color:' + data.colors.primary + ';margin-bottom:1.5rem">' + escapeHtml(heading) + '</h2><p style="color:' + textColor + ';line-height:1.8;font-size:1.05rem">' + escapeHtml(body.substring(0, 300)) + '</p></div></section>';
                } else {
                    sections += '<section class="content" style="background:' + bgColor + '"><div class="section-content"><h2 style="color:' + data.colors.primary + '">' + escapeHtml(heading) + '</h2><p style="color:' + textColor + ';margin-top:1rem">' + escapeHtml(body.substring(0, 200)) + '</p></div></section>';
                }
            }

            var googleFont = data.fonts.primary.replace(/ /g, '+');
            var css = ':root{--primary:' + data.colors.primary + ';--secondary:' + data.colors.secondary + ';--accent:' + data.colors.accent + ';--bg:#fff;--text:' + data.colors.foreground + '}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth;overflow-x:auto}body{font-family:"' + data.fonts.primary + '",-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;width:1400px;margin:0 auto}.progress-bar{position:fixed;top:0;left:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));z-index:1000;width:0;transition:width 0.3s ease}section{min-height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;padding:80px 60px}section.hero{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center}section.hero h1{font-size:4rem;margin-bottom:1.5rem;font-weight:800}section.hero p{font-size:1.5rem;opacity:0.95;max-width:800px;margin:0 auto}.section-content{max-width:1000px;width:100%;position:relative;z-index:10}h1,h2{font-weight:700;margin-bottom:1rem}h1{font-size:3.5rem}h2{font-size:2.5rem}p{font-size:1.2rem;margin-bottom:1rem;line-height:1.8}ul{margin-left:2rem;margin-bottom:1rem}li{margin-bottom:0.75rem;list-style:none;font-size:1.1rem}li:before{content:"‚ñ∏";margin-right:0.75rem;color:var(--secondary);font-weight:700}footer{padding:3rem;border-top:2px solid var(--primary);text-align:center;color:var(--text);opacity:0.7;font-size:1rem}@media(max-width:768px){body{width:375px}section{min-height:100vh;padding:60px 20px}section.hero h1{font-size:2rem;margin-bottom:1rem}section.hero p{font-size:1rem;max-width:335px}.section-content{max-width:335px}h1{font-size:1.75rem}h2{font-size:1.5rem}p{font-size:0.95rem;line-height:1.6}li{font-size:0.9rem}footer{padding:2rem;font-size:0.85rem}}@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}';

            var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>' + escapeHtml(data.slides[0].text.split('\n')[0] || 'Scrollytelling') + '</title><link href="https://fonts.googleapis.com/css2?family=' + googleFont + ':wght@400;600;700;800&display=swap" rel="stylesheet"><style>' + css + '</style></head><body><div class="progress-bar" id="pb"></div>' + sections + '<footer><p>Created with PPTX to Scrollytelling</p></footer><script>window.addEventListener("scroll",function(){var t=window.scrollY,h=document.documentElement.scrollHeight-window.innerHeight;document.getElementById("pb").style.width=(t/h*100)+"%"})<\/script></body></html>';

            return html;
        }

        function createOutputZip(data) {
            var zip = new JSZip();
            zip.file('index.html', generatedHTML);

            var assetsFolder = zip.folder('assets');
            for (var i = 0; i < data.images.length; i++) {
                var img = data.images[i];
                var filename = img.path.split('/').pop();
                assetsFolder.file(filename, img.data, { binary: true });
            }

            var report = 'BESPOKE DESIGN REPORT\n';
            report += '====================\n\n';
            report += 'Generated: ' + new Date().toISOString() + '\n\n';
            report += 'DESIGN ANALYSIS\n';
            report += 'Primary Font: ' + data.fonts.primary + '\n';
            report += 'Secondary Font: ' + data.fonts.secondary + '\n';
            report += 'Primary Color: ' + data.colors.primary + '\n';
            report += 'Secondary Color: ' + data.colors.secondary + '\n';
            report += 'Accent Color: ' + data.colors.accent + '\n\n';
            report += 'SLIDE ANALYSIS\n';
            report += 'Total Slides: ' + data.slides.length + '\n';
            for (var i = 0; i < data.slides.length; i++) {
                report += 'Slide ' + (i + 1) + ': ' + data.slides[i].layout + ' layout\n';
            }
            report += '\nCONTENT EXTRACTION\n';
            report += 'Images: ' + data.images.length + '\n\n';
            report += 'PROCESSING LOG\n';
            for (var i = 0; i < processingLog.length; i++) {
                report += '[' + processingLog[i].type.toUpperCase() + '] ' + processingLog[i].message + '\n';
            }

            zip.file('DESIGN_REPORT.txt', report);
            return zip;
        }

        generateBtn.addEventListener('click', function() {
            if (!selectedFile) return;
            loading.classList.add('show');
            generateBtn.disabled = true;
            preview.classList.remove('show');
            processingLog = [];

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    JSZip.loadAsync(e.target.result).then(function(pptxZip) {
                        loadingText.textContent = 'Analyzing design and extracting content...';
                        extractedData = extractPPTXData(pptxZip);

                        loadingText.textContent = 'Generating bespoke scrollytelling site...';
                        generatedHTML = generateBespokeHTML(extractedData);

                        loadingText.textContent = 'Creating download package...';
                        generatedZip = createOutputZip(extractedData);

                        loading.classList.remove('show');
                        generateBtn.disabled = false;
                        updateSummary();

                        previewIframe.srcdoc = generatedHTML;
                        preview.classList.add('show');

                        showStatus('‚úì Bespoke site generated! Review and download below.', 'ok');
                    }).catch(function(error) {
                        console.error('Error:', error);
                        loading.classList.remove('show');
                        generateBtn.disabled = false;
                        addLog('Fatal error: ' + error.message, 'err');
                        updateSummary();
                        showStatus('Error: ' + error.message, 'err');
                    });
                } catch (error) {
                    console.error('Error:', error);
                    loading.classList.remove('show');
                    generateBtn.disabled = false;
                    addLog('Fatal error: ' + error.message, 'err');
                    updateSummary();
                    showStatus('Error: ' + error.message, 'err');
                }
            };
            reader.onerror = function() {
                loading.classList.remove('show');
                generateBtn.disabled = false;
                addLog('File read error', 'err');
                updateSummary();
                showStatus('Error reading file', 'err');
            };
            reader.readAsArrayBuffer(selectedFile);
        });

        downloadBtn.addEventListener('click', function() {
            if (!generatedZip) return;
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';

            generatedZip.generateAsync({ type: 'blob' }).then(function(blob) {
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'scrollytelling.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('‚úì Download complete!', 'ok');
                downloadBtn.disabled = false;
                downloadBtn.textContent = '‚úì Download ZIP';
            }).catch(function(error) {
                console.error('Download error:', error);
                showStatus('Error downloading: ' + error.message, 'err');
                downloadBtn.disabled = false;
                downloadBtn.textContent = '‚úì Download ZIP';
            });
        });

        editBtn.addEventListener('click', function() {
            preview.classList.remove('show');
            generateBtn.disabled = false;
        });

        resetBtn.addEventListener('click', function() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
            generateBtn.disabled = true;
            uploadStatus.classList.remove('show');
            preview.classList.remove('show');
            summary.classList.remove('show');
            processingLog = [];
        });
    </script>
</body>
</html>
