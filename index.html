<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTX to Scrollytelling</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #00d9ff;
            color: #0f0a1a;
            padding: 8px;
            text-decoration: none;
            z-index: 10000;
            font-weight: 600;
        }
        .skip-link:focus {
            top: 0;
        }
        
        body { 
            font-family: 'Titillium Web', sans-serif; 
            background: linear-gradient(135deg, #0f0a1a, #1a0a2e); 
            color: #f5f5f5; 
            min-height: 100vh; 
            padding: 2rem; 
        }
        
        /* High contrast mode */
        body[data-contrast="high"] {
            background: #000;
            color: #fff;
        }
        body[data-contrast="high"] .box,
        body[data-contrast="high"] .preview {
            background: #000;
            border: 2px solid #fff;
        }
        body[data-contrast="high"] .btn-main {
            background: #fff;
            color: #000;
            border: 2px solid #fff;
        }
        body[data-contrast="high"] .btn-sec {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
        }
        
        /* Respect prefers-reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        header h1 { 
            font-size: 2.5rem; 
            margin-bottom: 1rem; 
            background: linear-gradient(135deg, #00d9ff, #a855f7); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
        }
        .subtitle { color: rgba(255,255,255,0.6); margin-bottom: 3rem; }
        
        .accessibility-controls {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .accessibility-controls button {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #f5f5f5;
            border-radius: 0.5rem;
            cursor: pointer;
            font-family: 'Titillium Web', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .accessibility-controls button:hover,
        .accessibility-controls button:focus {
            border-color: #00d9ff;
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .box { padding: 2rem; border-radius: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .box h2 { font-size: 1.2rem; margin-bottom: 1.5rem; color: #00d9ff; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        input[type="text"] { 
            width: 100%; 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 1px solid rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.05); 
            color: #f5f5f5; 
            font-family: 'Titillium Web', sans-serif; 
        }
        input[type="text"]:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
            border-color: #00d9ff;
        }
        
        .colors { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .color-btn { 
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            border: 2px solid transparent; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
        }
        .color-btn:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        .color-btn.active { border-color: #00d9ff; box-shadow: 0 0 10px rgba(0,217,255,0.3); }
        
        /* Enhanced drop zone for accessibility */
        .drop { 
            border: 2px dashed rgba(255,255,255,0.3); 
            border-radius: 1rem; 
            padding: 2rem; 
            text-align: center; 
            cursor: pointer;
            position: relative;
        }
        .drop:focus-within {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
            border-color: #00d9ff;
        }
        .drop.over { border-color: #00d9ff; background: rgba(0,217,255,0.1); }
        
        .file-info { 
            margin-top: 1rem; 
            padding: 0.75rem; 
            background: rgba(34,197,94,0.1); 
            border-left: 3px solid #22c55e; 
            border-radius: 0.5rem; 
            color: #bbf7d0; 
            display: none; 
        }
        
        .buttons { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        button { 
            flex: 1; 
            padding: 1rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-family: 'Titillium Web', sans-serif; 
            font-weight: 600; 
            cursor: pointer;
            min-width: 120px;
        }
        button:focus {
            outline: 2px solid #00d9ff;
            outline-offset: 2px;
        }
        .btn-main { background: linear-gradient(135deg, #00d9ff, #a855f7); color: #0f0a1a; }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sec { background: rgba(255,255,255,0.1); color: #f5f5f5; border: 1px solid rgba(255,255,255,0.2); }
        
        .msg { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: none; }
        .msg.show { display: block; }
        .msg.ok { background: rgba(34,197,94,0.1); border-left: 3px solid #22c55e; color: #bbf7d0; }
        .msg.err { background: rgba(239,68,68,0.1); border-left: 3px solid #ef4444; color: #fca5a5; }
        .msg.warn { background: rgba(251,191,36,0.1); border-left: 3px solid #fbbf24; color: #fde68a; }
        
        .spin { 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top: 3px solid #00d9ff; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 1rem; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .preview { 
            display: none; 
            margin-top: 2rem; 
            padding: 2rem; 
            border-radius: 1rem; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .preview.show { display: block; }
        .preview h3 { color: #00d9ff; margin-bottom: 1rem; }
        .preview iframe { 
            width: 100%; 
            height: 500px; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 0.5rem; 
            background: white; 
        }
        
        .summary-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.5rem;
            display: none;
        }
        .summary-panel.show { display: block; }
        .summary-panel h4 { color: #00d9ff; margin-bottom: 0.5rem; }
        .summary-panel ul { 
            list-style: none; 
            padding-left: 0; 
        }
        .summary-panel li { 
            padding: 0.25rem 0; 
            color: rgba(255,255,255,0.8);
        }
        .summary-panel .warning { color: #fbbf24; }
        .summary-panel .error { color: #ef4444; }
        .summary-panel .success { color: #22c55e; }
        
        /* Aria-live region */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        @media (max-width: 768px) { 
            .grid { grid-template-columns: 1fr; } 
            .buttons { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Aria-live region for screen reader announcements -->
    <div class="sr-only" aria-live="polite" aria-atomic="true" id="ariaLive"></div>
    
    <a href="#main" class="skip-link">Skip to main content</a>
    
    <div class="container">
        <header>
            <h1>PPTX to Scrollytelling</h1>
            <p class="subtitle">Convert your PowerPoint to a WCAG-ready scrollytelling site</p>
            
            <div class="accessibility-controls">
                <button id="contrastToggle" aria-label="Toggle high contrast mode">
                    High Contrast Mode
                </button>
            </div>
        </header>
        
        <main id="main">
        <div class="grid">
            <div class="box">
                <h2>Upload PPTX</h2>
                <label for="file" style="cursor: pointer;">
                    <div class="drop" id="drop" role="button" tabindex="0" aria-label="Upload PowerPoint file. Drag and drop or click to browse">
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;" aria-hidden="true">ðŸ“¤</div>
                        <p><strong>Drag & drop PPTX here</strong></p>
                        <p style="color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-top: 0.5rem;">or click to browse</p>
                        <input type="file" id="file" style="display: none;" accept=".pptx" aria-label="Select PowerPoint file">
                    </div>
                </label>
                <div class="file-info" id="info" role="status"></div>
                <div class="msg" id="status" role="status" aria-live="polite" aria-atomic="true"></div>
                <div class="summary-panel" id="summary">
                    <h4>Processing Summary</h4>
                    <ul id="summaryList"></ul>
                </div>
            </div>

            <div class="box">
                <h2>Customize</h2>
                <div class="form-group">
                    <label for="title">Site Title</label>
                    <input type="text" id="title" value="Driving Meaningful Health Change" aria-required="false">
                </div>
                <div class="form-group">
                    <label for="copy">Copyright</label>
                    <input type="text" id="copy" value="Â© 2026 The Gaf NYC" aria-required="false">
                </div>
                <div class="form-group">
                    <label id="themeLabel">Theme</label>
                    <div class="colors" role="radiogroup" aria-labelledby="themeLabel">
                        <button class="color-btn active" data-t="cyber" style="background: linear-gradient(135deg, #0f0a1a, #1a0a2e); color: #00d9ff;" role="radio" aria-checked="true">Cyber</button>
                        <button class="color-btn" data-t="ocean" style="background: linear-gradient(135deg, #0a1f2e, #1a3a4a); color: #00d9ff;" role="radio" aria-checked="false">Ocean</button>
                        <button class="color-btn" data-t="forest" style="background: linear-gradient(135deg, #0a2e1a, #1a4a2e); color: #22c55e;" role="radio" aria-checked="false">Forest</button>
                        <button class="color-btn" data-t="sunset" style="background: linear-gradient(135deg, #2e1a0a, #4a2e1a); color: #f97316;" role="radio" aria-checked="false">Sunset</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="load" style="display: none; text-align: center; padding: 2rem;" role="status" aria-live="polite">
            <div class="spin" aria-hidden="true"></div>
            <p id="loadtxt">Processing...</p>
        </div>

        <div class="preview" id="prev">
            <h3>Preview</h3>
            <iframe id="iframe" sandbox="allow-scripts" title="Preview of generated scrollytelling site"></iframe>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn-sec" id="edit" style="flex: 1;">Edit</button>
                <button class="btn-main" id="down" style="flex: 1;">Download</button>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-main" id="gen" disabled aria-describedby="genDesc">Generate Site</button>
            <button class="btn-sec" id="cancel" disabled>Cancel</button>
            <button class="btn-sec" id="reset">Reset</button>
        </div>
        <p id="genDesc" class="sr-only">Generate the scrollytelling site from your PowerPoint file</p>
        </main>
        
        <footer style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; color: rgba(255,255,255,0.5);">
            <p>PPTX to Scrollytelling Converter</p>
        </footer>
    </div>

    <script>
        // Global state
        var file = null, theme = 'cyber', html = null, zip = null, cancelled = false;
        var slideData = [];
        var summaryData = { slides: 0, images: [], warnings: [], errors: [] };
        var hasTextOverBackground = false;  // Track if text appears over background images
        
        // DOM elements
        var drop = document.getElementById('drop');
        var inp = document.getElementById('file');
        var info = document.getElementById('info');
        const statusEl = document.getElementById('status');  // Use const to prevent shadowing
        var load = document.getElementById('load');
        var prev = document.getElementById('prev');
        var gen = document.getElementById('gen');
        var down = document.getElementById('down');
        var edit = document.getElementById('edit');
        var reset = document.getElementById('reset');
        var cancelBtn = document.getElementById('cancel');
        var iframe = document.getElementById('iframe');
        var titleinp = document.getElementById('title');
        var copyinp = document.getElementById('copy');
        var contrastToggle = document.getElementById('contrastToggle');
        var ariaLive = document.getElementById('ariaLive');
        var summary = document.getElementById('summary');
        var summaryList = document.getElementById('summaryList');

        var themes = {
            cyber: {bg1: '#0f0a1a', bg2: '#1a0a2e', p: '#00d9ff', s: '#a855f7'},
            ocean: {bg1: '#0a1f2e', bg2: '#1a3a4a', p: '#00d9ff', s: '#0ea5e9'},
            forest: {bg1: '#0a2e1a', bg2: '#1a4a2e', p: '#22c55e', s: '#10b981'},
            sunset: {bg1: '#2e1a0a', bg2: '#4a2e1a', p: '#f97316', s: '#fb923c'}
        };
        
        // Bullet point detection pattern - common Unicode bullet characters
        var BULLET_PATTERN = /^[\u2022\u2023\u25E6\u2043\u2219\u00B7\u2023\u2043]/;

        // Utility functions
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function sanitizeFilename(filename) {
            return filename.replace(/[^a-zA-Z0-9._-]/g, '_');
        }

        function announceToScreenReader(message) {
            ariaLive.textContent = message;
            setTimeout(function() { ariaLive.textContent = ''; }, 1000);
        }

        function updateSummary() {
            summaryList.innerHTML = '';
            
            var items = [
                '<li class="success">Slides found: ' + summaryData.slides + '</li>'
            ];
            
            summaryData.images.forEach(function(img) {
                items.push('<li>Slide ' + img.slide + ': ' + img.count + ' image(s)</li>');
            });
            
            summaryData.warnings.forEach(function(warn) {
                items.push('<li class="warning">âš  ' + escapeHtml(warn) + '</li>');
            });
            
            summaryData.errors.forEach(function(err) {
                items.push('<li class="error">âœ— ' + escapeHtml(err) + '</li>');
            });
            
            summaryList.innerHTML = items.join('');
            summary.classList.add('show');
        }

        // High contrast toggle
        contrastToggle.addEventListener('click', function() {
            var isHighContrast = document.body.getAttribute('data-contrast') === 'high';
            if (isHighContrast) {
                document.body.removeAttribute('data-contrast');
                contrastToggle.textContent = 'High Contrast Mode';
                announceToScreenReader('High contrast mode disabled');
            } else {
                document.body.setAttribute('data-contrast', 'high');
                contrastToggle.textContent = 'Normal Contrast Mode';
                announceToScreenReader('High contrast mode enabled');
            }
        });

        // File handling
        drop.onclick = function() { inp.click(); };
        
        drop.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                inp.click();
            }
        });
        
        drop.ondragover = function(e) { 
            e.preventDefault(); 
            drop.classList.add('over'); 
        };
        
        drop.ondragleave = function() { 
            drop.classList.remove('over'); 
        };
        
        drop.ondrop = function(e) { 
            e.preventDefault(); 
            drop.classList.remove('over'); 
            handleFile(e.dataTransfer.files[0]); 
        };
        
        inp.onchange = function(e) { 
            handleFile(e.target.files[0]); 
        };

        function handleFile(f) {
            if (!f || !f.name.toLowerCase().endsWith('.pptx')) {
                statusEl.textContent = 'Please select a PPTX file';
                statusEl.className = 'msg show err';
                // Set assertive for errors
                statusEl.setAttribute('aria-live', 'assertive');
                statusEl.setAttribute('role', 'alert');
                announceToScreenReader('Error: Please select a PPTX file');
                return;
            }
            file = f;
            info.textContent = 'âœ“ ' + f.name;
            info.style.display = 'block';
            gen.disabled = false;
            statusEl.textContent = 'Ready to process';
            statusEl.className = 'msg show ok';
            // Return to polite status for non-errors
            statusEl.setAttribute('aria-live', 'polite');
            statusEl.setAttribute('role', 'status');
            announceToScreenReader('File loaded successfully: ' + f.name);
        }

        // Theme selection
        document.querySelectorAll('.color-btn').forEach(function(btn) {
            btn.onclick = function() {
                document.querySelectorAll('.color-btn').forEach(function(b) { 
                    b.classList.remove('active');
                    b.setAttribute('aria-checked', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-checked', 'true');
                theme = btn.dataset.t;
                announceToScreenReader('Theme changed to ' + theme);
            };
        });

        // Main generation function
        gen.onclick = function() {
            if (!file) return;
            
            cancelled = false;
            load.style.display = 'block';
            gen.disabled = true;
            cancelBtn.disabled = false;
            summaryData = { slides: 0, images: [], warnings: [], errors: [] };
            summary.classList.remove('show');
            
            announceToScreenReader('Processing PowerPoint file');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                processZip(e.target.result);
            };
            reader.readAsArrayBuffer(file);
        };

        async function processZip(arrayBuffer) {
            try {
                var zipFile = await JSZip.loadAsync(arrayBuffer);
                zip = zipFile;
                
                if (cancelled) {
                    resetProcessing();
                    return;
                }
                
                // Validate PPTX structure
                var contentTypesFile = zipFile.file('[Content_Types].xml');
                var slideFolder = zipFile.folder('ppt/slides');
                var relsFolder = zipFile.folder('ppt/slides/_rels');
                
                if (!contentTypesFile) {
                    throw new Error('Invalid PPTX file: Missing [Content_Types].xml');
                }
                if (!slideFolder) {
                    throw new Error('Invalid PPTX file: No slides found');
                }
                
                var slideFiles = Object.keys(slideFolder.files)
                    .filter(function(f) { return f.match(/slide\d+\.xml$/); })
                    .sort(function(a, b) {
                        var matchA = a.match(/\d+/);
                        var matchB = b.match(/\d+/);
                        var numA = matchA ? parseInt(matchA[0]) : 0;
                        var numB = matchB ? parseInt(matchB[0]) : 0;
                        return numA - numB;
                    });
                
                if (slideFiles.length === 0) {
                    throw new Error('Invalid PPTX file: No slide content found');
                }
                
                summaryData.slides = slideFiles.length;
                document.getElementById('loadtxt').textContent = 'Processing ' + slideFiles.length + ' slides...';
                
                slideData = [];
                
                for (var i = 0; i < slideFiles.length; i++) {
                    if (cancelled) {
                        resetProcessing();
                        return;
                    }
                    
                    var slideNum = i + 1;
                    document.getElementById('loadtxt').textContent = 'Processing slide ' + slideNum + ' of ' + slideFiles.length + '...';
                    
                    var slideXml = await slideFolder.file(slideFiles[i]).async('string');
                    var slideImages = await getSlideImages(zipFile, slideNum, slideXml);
                    var slideText = parseSlideText(slideXml);
                    
                    summaryData.images.push({ slide: slideNum, count: slideImages.length });
                    
                    slideData.push({
                        num: slideNum,
                        text: slideText,
                        images: slideImages
                    });
                }
                
                if (cancelled) {
                    resetProcessing();
                    return;
                }
                
                html = await makeHTML(slideData);
                
                iframe.srcdoc = html;
                prev.classList.add('show');
                load.style.display = 'none';
                gen.disabled = false;
                cancelBtn.disabled = true;
                statusEl.textContent = 'Site generated successfully';
                statusEl.className = 'msg show ok';
                // Return to polite status for non-errors
                statusEl.setAttribute('aria-live', 'polite');
                statusEl.setAttribute('role', 'status');
                announceToScreenReader('Site generated successfully. Preview is ready.');
                
                updateSummary();
                
            } catch (e) {
                summaryData.errors.push(e.message);
                statusEl.textContent = 'Error: ' + e.message;
                statusEl.className = 'msg show err';
                // Set assertive for errors
                statusEl.setAttribute('aria-live', 'assertive');
                statusEl.setAttribute('role', 'alert');
                load.style.display = 'none';
                gen.disabled = false;
                cancelBtn.disabled = true;
                announceToScreenReader('Error: ' + e.message);
                updateSummary();
            }
        }

        async function getSlideImages(zipFile, slideNum, slideXml) {
            var images = [];
            
            try {
                // Parse slide XML to find image references (r:embed or r:id attributes)
                var slideParser = new DOMParser();
                var slideDoc = slideParser.parseFromString(slideXml, 'text/xml');
                
                // Find all image references in the slide with their extents
                var picElements = slideDoc.getElementsByTagName('p:pic');
                var imageRefs = [];
                
                for (var i = 0; i < picElements.length; i++) {
                    var blipElements = picElements[i].getElementsByTagName('a:blip');
                    for (var j = 0; j < blipElements.length; j++) {
                        var embedAttr = blipElements[j].getAttribute('r:embed') || blipElements[j].getAttribute('r:link');
                        if (embedAttr) {
                            // Try to get picture extent (size) from transform
                            var extElements = picElements[i].getElementsByTagName('a:ext');
                            var cx = 0, cy = 0;
                            if (extElements.length > 0) {
                                var cxAttr = extElements[0].getAttribute('cx');
                                var cyAttr = extElements[0].getAttribute('cy');
                                cx = cxAttr ? parseInt(cxAttr) : 0;
                                cy = cyAttr ? parseInt(cyAttr) : 0;
                            }
                            imageRefs.push({
                                rId: embedAttr,
                                area: cx * cy,  // Calculate area for heuristic
                                cx: cx,
                                cy: cy
                            });
                        }
                    }
                }
                
                // Load relationship file
                var relsPath = 'ppt/slides/_rels/slide' + slideNum + '.xml.rels';
                var relsFile = zipFile.file(relsPath);
                
                if (!relsFile) {
                    // No relationships file - no images
                    if (imageRefs.length > 0) {
                        summaryData.warnings.push('Slide ' + slideNum + ': Found image references but no relationships file');
                    }
                    return images;
                }
                
                var relsXml = await relsFile.async('string');
                var relsParser = new DOMParser();
                var relsDoc = relsParser.parseFromString(relsXml, 'text/xml');
                
                // Build a map of relationship IDs to image targets
                var relationships = relsDoc.querySelectorAll('Relationship');
                var relMap = {};
                
                for (var i = 0; i < relationships.length; i++) {
                    var rel = relationships[i];
                    var relId = rel.getAttribute('Id');
                    var type = rel.getAttribute('Type');
                    var target = rel.getAttribute('Target');
                    
                    if (type && type.includes('image') && target && relId) {
                        relMap[relId] = target;
                    }
                }
                
                // Match image references to actual files
                var loadedImages = [];
                for (var i = 0; i < imageRefs.length; i++) {
                    var refId = imageRefs[i].rId;
                    var area = imageRefs[i].area;
                    var target = relMap[refId];
                    
                    if (!target) {
                        summaryData.warnings.push('Slide ' + slideNum + ': Could not resolve image reference ' + refId);
                        continue;
                    }
                    
                    // Resolve path: targets are relative to ppt/slides/
                    // If target starts with ../,  resolve against ppt/
                    var imagePath;
                    if (target.startsWith('../')) {
                        // Remove ../ and prepend ppt/
                        imagePath = 'ppt/' + target.substring(3);
                    } else {
                        // Relative to ppt/slides/
                        imagePath = 'ppt/slides/' + target;
                    }
                    
                    var imageFile = zipFile.file(imagePath);
                    
                    if (imageFile) {
                        var imageData = await imageFile.async('base64');
                        var ext = imagePath.split('.').pop().toLowerCase();
                        
                        // Validate and map file extensions to MIME types
                        var mimeTypeMap = {
                            'jpg': 'image/jpeg',
                            'jpeg': 'image/jpeg',
                            'png': 'image/png',
                            'gif': 'image/gif',
                            'svg': 'image/svg+xml',
                            'bmp': 'image/bmp',
                            'webp': 'image/webp'
                        };
                        
                        var mimeType = mimeTypeMap[ext];
                        if (!mimeType) {
                            summaryData.warnings.push('Unknown image format: ' + ext + ' in slide ' + slideNum);
                            mimeType = 'image/png'; // Default fallback
                        }
                        
                        loadedImages.push({
                            data: 'data:' + mimeType + ';base64,' + imageData,
                            rId: refId,
                            area: area,
                            cx: imageRefs[i].cx || 0,
                            cy: imageRefs[i].cy || 0
                        });
                    } else {
                        summaryData.warnings.push('Slide ' + slideNum + ': Image file not found: ' + imagePath);
                    }
                }
                
                // Choose background image: use aspect ratio similarity + area heuristic
                if (loadedImages.length > 0) {
                    // Standard slide aspect ratio is 16:9 (1.7778) or 4:3 (1.3333)
                    // We'll use 16:9 as default target
                    var targetAspectRatio = 16 / 9;
                    var bestScore = -1;
                    var backgroundIndex = 0;
                    var hasExtents = false;
                    var selectionReason = '';
                    
                    for (var i = 0; i < loadedImages.length; i++) {
                        if (loadedImages[i].area > 0) {
                            hasExtents = true;
                            // Calculate aspect ratio from cx and cy
                            var imageAspectRatio = loadedImages[i].cx / loadedImages[i].cy;
                            var aspectDiff = Math.abs(imageAspectRatio - targetAspectRatio);
                            
                            // Score: prefer images with aspect ratio closer to slide AND larger area
                            // Lower aspect difference is better, higher area is better
                            // Normalize scores so aspect ratio has more weight
                            var aspectScore = 1 / (1 + aspectDiff);  // Closer to 1 is better
                            var areaScore = loadedImages[i].area;
                            
                            // Combined score: aspect ratio weighted more heavily
                            var score = (aspectScore * 1000000) + (areaScore * 0.1);
                            
                            if (score > bestScore) {
                                bestScore = score;
                                backgroundIndex = i;
                                selectionReason = 'aspect-ratio-and-area';
                            }
                        }
                    }
                    
                    // Fallback if no extents: use first image
                    if (!hasExtents) {
                        selectionReason = 'first-image-fallback';
                    }
                    
                    // Mark the chosen background
                    for (var i = 0; i < loadedImages.length; i++) {
                        images.push({
                            data: loadedImages[i].data,
                            rId: loadedImages[i].rId,
                            isBackground: i === backgroundIndex,
                            selectionReason: i === backgroundIndex ? selectionReason : ''
                        });
                    }
                    
                    // Store heuristic info for accessibility report
                    if (!summaryData.backgroundHeuristic) {
                        summaryData.backgroundHeuristic = {};
                    }
                    summaryData.backgroundHeuristic[slideNum] = selectionReason;
                }
                
                // Add note if no images were resolved
                if (imageRefs.length > 0 && images.length === 0) {
                    summaryData.warnings.push('Slide ' + slideNum + ': Could not load any images despite ' + imageRefs.length + ' reference(s)');
                }
                
            } catch (e) {
                summaryData.warnings.push('Could not load images for slide ' + slideNum + ': ' + e.message);
            }
            
            return images;
        }

        function parseSlideText(xml) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(xml, 'text/xml');
            
            // First, try to find title placeholder text
            // Look for p:sp elements with p:ph type="title" or "ctrTitle"
            var titleText = '';
            var titleSource = '';
            var shapes = doc.getElementsByTagName('p:sp');
            
            for (var i = 0; i < shapes.length; i++) {
                var shape = shapes[i];
                var phElements = shape.getElementsByTagName('p:ph');
                
                for (var j = 0; j < phElements.length; j++) {
                    var phType = phElements[j].getAttribute('type');
                    if (phType === 'title' || phType === 'ctrTitle') {
                        // Extract text from this shape
                        var txBodyElements = shape.getElementsByTagName('p:txBody');
                        if (txBodyElements.length > 0) {
                            var textElements = txBodyElements[0].getElementsByTagName('a:t');
                            var extractedText = '';
                            for (var k = 0; k < textElements.length; k++) {
                                extractedText += textElements[k].textContent;
                            }
                            extractedText = extractedText.trim();
                            if (extractedText) {
                                titleText = extractedText;
                                titleSource = 'title-placeholder';
                                break;
                            }
                        }
                    }
                }
                if (titleText) break;
            }
            
            // Get all paragraph elements (a:p or p)
            var aParagraphs = doc.getElementsByTagName('a:p');
            var plainParagraphs = doc.getElementsByTagName('p');
            
            var paragraphs = [];
            
            // Process a:p elements
            for (var i = 0; i < aParagraphs.length; i++) {
                var para = aParagraphs[i];
                
                // Check if paragraph has bullet properties
                var hasBullet = false;
                var pPrElements = para.getElementsByTagName('a:pPr');
                
                if (pPrElements.length > 0) {
                    var pPr = pPrElements[0];
                    // Check for bullet character (a:buChar) or auto-numbering (a:buAutoNum)
                    var buChar = pPr.getElementsByTagName('a:buChar');
                    var buAutoNum = pPr.getElementsByTagName('a:buAutoNum');
                    var buNone = pPr.getElementsByTagName('a:buNone');
                    
                    // Has bullet if buChar or buAutoNum present, and buNone not present
                    if ((buChar.length > 0 || buAutoNum.length > 0) && buNone.length === 0) {
                        hasBullet = true;
                    }
                }
                
                // Extract text from paragraph
                var textElements = para.getElementsByTagName('a:t');
                var paraText = '';
                for (var j = 0; j < textElements.length; j++) {
                    paraText += textElements[j].textContent;
                }
                
                paraText = paraText.trim();
                if (paraText) {
                    paragraphs.push({
                        text: paraText,
                        isBullet: hasBullet
                    });
                }
            }
            
            // Process plain p elements if no a:p found
            if (paragraphs.length === 0) {
                for (var i = 0; i < plainParagraphs.length; i++) {
                    var para = plainParagraphs[i];
                    var textElements = para.getElementsByTagName('t');
                    var paraText = '';
                    for (var j = 0; j < textElements.length; j++) {
                        paraText += textElements[j].textContent;
                    }
                    
                    paraText = paraText.trim();
                    if (paraText) {
                        // Fallback: detect bullets by Unicode characters
                        var hasBullet = BULLET_PATTERN.test(paraText);
                        paragraphs.push({
                            text: paraText,
                            isBullet: hasBullet
                        });
                    }
                }
            }
            
            var result = {
                heading: '',
                headingSource: '',
                content: []
            };
            
            // Use title placeholder if found
            if (titleText) {
                result.heading = titleText;
                result.headingSource = titleSource;
                // All paragraphs become content
                result.content = paragraphs;
            } else {
                // Fallback: First non-bullet paragraph becomes heading
                for (var i = 0; i < paragraphs.length; i++) {
                    if (!paragraphs[i].isBullet && paragraphs[i].text) {
                        result.heading = paragraphs[i].text;
                        result.headingSource = 'first-non-bullet';
                        // Rest becomes content
                        for (var j = i + 1; j < paragraphs.length; j++) {
                            result.content.push(paragraphs[j]);
                        }
                        break;
                    }
                }
            }
            
            // If all paragraphs are bullets or no heading found, use first as heading
            if (!result.heading && paragraphs.length > 0) {
                result.heading = paragraphs[0].text;
                for (var i = 1; i < paragraphs.length; i++) {
                    result.content.push(paragraphs[i]);
                }
            }
            
            return result;
        }

        async function makeHTML(slides) {
            var t = themes[theme];
            var secs = '';
            
            for (var i = 0; i < slides.length; i++) {
                var slide = slides[i];
                var bgStyle = '';
                var inlineImages = '';
                var bgComment = '';
                var headingComment = '';
                
                if (slide.images.length > 0) {
                    var bgImage = slide.images.find(function(img) { return img.isBackground; }) || slide.images[0];
                    bgStyle = 'background-image: url(' + bgImage.data + '); background-size: cover; background-position: center;';
                    
                    // Generate instructional comment explaining background selection
                    var bgReason = bgImage.selectionReason || 'unknown';
                    if (bgReason === 'aspect-ratio-and-area') {
                        bgComment = '<!-- ========== BACKGROUND IMAGE ==========\n' +
                            '             HOW IT WAS CHOSEN:\n' +
                            '             This image was automatically selected as the background because:\n' +
                            '             â€¢ It has an aspect ratio similar to a standard slide (16:9)\n' +
                            '             â€¢ It is one of the larger images on this slide\n' +
                            '             \n' +
                            '             YOU CAN:\n' +
                            '             â€¢ Keep it as-is if it looks good\n' +
                            '             â€¢ Swap it with another image from your slide\n' +
                            '             â€¢ Remove it entirely by deleting the style="background-image..." part\n' +
                            '             \n' +
                            '             ACCESSIBILITY NOTE:\n' +
                            '             Background images are decorative (CSS only).\n' +
                            '             Important content images should be inline <img> tags with alt text.\n' +
                            '             ===================================== -->\n        ';
                    } else if (bgReason === 'first-image-fallback') {
                        bgComment = '<!-- ========== BACKGROUND IMAGE ==========\n' +
                            '             HOW IT WAS CHOSEN:\n' +
                            '             This image was chosen as the background by default\n' +
                            '             (it appeared first in the slide and size info was unavailable).\n' +
                            '             \n' +
                            '             PLEASE REVIEW:\n' +
                            '             â€¢ Check if this image makes sense as a background\n' +
                            '             â€¢ You may want to swap it with a different image\n' +
                            '             â€¢ Consider if any image should be background at all\n' +
                            '             \n' +
                            '             TO REMOVE:\n' +
                            '             Delete the style="background-image..." attribute from <section>\n' +
                            '             ===================================== -->\n        ';
                    } else {
                        bgComment = '<!-- BACKGROUND IMAGE: This image is displayed as the background for this section. You can safely change or remove it if desired. -->\n        ';
                    }
                    
                    var additionalImages = slide.images.slice(1);
                    additionalImages.forEach(function(img, idx) {
                        // Generate descriptive alt text based on slide content
                        var altText = '';
                        if (slide.text.heading) {
                            altText = 'Supporting image for ' + escapeHtml(slide.text.heading);
                            if (additionalImages.length > 1) {
                                altText += ' (image ' + (idx + 1) + ' of ' + additionalImages.length + ')';
                            }
                        } else {
                            altText = 'Image ' + (idx + 1) + ' from slide ' + (i + 1);
                        }
                        inlineImages += '<!-- ===== INLINE IMAGE =====\n' +
                            '                   PURPOSE: This image appears within the content (not as background)\n' +
                            '                   ALT TEXT: "' + altText + '"\n' +
                            '                   \n' +
                            '                   ACTION REQUIRED:\n' +
                            '                   â€¢ Review the alt text to ensure it accurately describes this image\n' +
                            '                   â€¢ If the image contains important text, include that text in alt\n' +
                            '                   â€¢ If the image is decorative, you can use alt=""\n' +
                            '                   \n' +
                            '                   EDIT: You can change the alt="..." text or remove this image entirely.\n' +
                            '                   ====================== -->\n          <img src="' + img.data + '" alt="' + altText + '" loading="lazy" style="max-width: 100%; height: auto; margin: 1rem 0; border-radius: 0.5rem;">\n          ';
                    });
                }
                
                var heading = slide.text.heading ? '<h2>' + escapeHtml(slide.text.heading) + '</h2>' : '';
                var content = '';
                
                // Generate heading comment explaining how it was chosen
                if (slide.text.heading) {
                    if (slide.text.headingSource === 'title-placeholder') {
                        headingComment = '<!-- ===== HEADING =====\n' +
                            '                   EXTRACTED FROM: PowerPoint title placeholder\n' +
                            '                   CONFIDENCE: High (this was marked as the slide title)\n' +
                            '                   ACTION: Verify the heading accurately describes this section.\n' +
                            '                   EDIT: You can safely change this text.\n' +
                            '                   ================== -->\n          ';
                    } else if (slide.text.headingSource === 'first-non-bullet') {
                        headingComment = '<!-- ===== HEADING =====\n' +
                            '                   INFERRED FROM: First non-bullet text on slide\n' +
                            '                   CONFIDENCE: Medium (best guess, no title placeholder found)\n' +
                            '                   ACTION: PLEASE VERIFY this is the correct heading!\n' +
                            '                   EDIT: You can safely change this text or move it to content if not a heading.\n' +
                            '                   ================== -->\n          ';
                    } else {
                        headingComment = '<!-- HEADING: This is the main heading for this section. You can safely edit this text. -->\n          ';
                    }
                }
                
                // Generate stable ID for heading and aria-labelledby for section
                var slideId = 'slide-' + (i + 1) + '-title';
                var ariaLabel = '';
                if (slide.text.heading) {
                    heading = '<h2 id="' + slideId + '">' + escapeHtml(slide.text.heading) + '</h2>';
                    ariaLabel = ' aria-labelledby="' + slideId + '"';
                }
                
                if (slide.text.content.length > 0) {
                    var bullets = [];
                    var paras = [];
                    
                    slide.text.content.forEach(function(item) {
                        if (item.isBullet) {
                            // Only strip leading bullet character if it actually exists
                            var cleanText = item.text;
                            if (BULLET_PATTERN.test(cleanText)) {
                                cleanText = cleanText.replace(BULLET_PATTERN, '').replace(/^\s+/, '');
                            }
                            bullets.push('<li>' + escapeHtml(cleanText) + '</li>');
                        } else {
                            if (bullets.length > 0) {
                                content += '<ul>' + bullets.join('') + '</ul>';
                                bullets = [];
                            }
                            content += '<p>' + escapeHtml(item.text) + '</p>';
                        }
                    });
                    
                    if (bullets.length > 0) {
                        content += '<ul>' + bullets.join('') + '</ul>';
                    }
                }
                
                // Build section with aria-labelledby if heading exists
                var sectionHeader = '<!-- ========================================\n' +
                    '         SLIDE ' + (i + 1) + (slide.text.heading ? ': ' + escapeHtml(slide.text.heading) : '') + '\n' +
                    '         \n' +
                    '         WHAT CAME FROM POWERPOINT:\n' +
                    '         â€¢ Text content (heading, paragraphs, bullets)\n' +
                    '         â€¢ Images embedded in this slide\n' +
                    '         \n' +
                    '         WHAT WAS AUTOMATICALLY DECIDED:\n' +
                    '         â€¢ Background image selection (based on size/aspect ratio)\n' +
                    '         â€¢ Heading detection (from title placeholder or first text)\n' +
                    '         â€¢ Layout and spacing\n' +
                    '         \n' +
                    '         YOU CAN SAFELY EDIT:\n' +
                    '         â€¢ All text between tags (headings, paragraphs, list items)\n' +
                    '         â€¢ Alt text for images\n' +
                    '         â€¢ You can swap or remove the background image\n' +
                    '         \n' +
                    '         DO NOT EDIT (unless you know CSS/HTML):\n' +
                    '         â€¢ The style attribute (controls background image)\n' +
                    '         â€¢ The aria-labelledby attribute (accessibility feature)\n' +
                    '         â€¢ The <div> structure (needed for overlay effect)\n' +
                    '         ======================================== -->\n      ';
                secs += sectionHeader + bgComment + '<section' + ariaLabel + ' style="' + bgStyle + '">\n        <div class="ov"></div>\n        <div class="con">\n          ' + headingComment + heading + '\n          <!-- CONTENT: The paragraphs and lists below were extracted from your slide. You can edit, add, or remove any of this content. -->\n          ' + content + inlineImages + '\n        </div>\n      </section>\n      ';
            }

            // Check if any slides have text over background images
            hasTextOverBackground = false;  // Reset global state
            for (var i = 0; i < slides.length; i++) {
                if (slides[i].images.length > 0 && (slides[i].text.heading || slides[i].text.content.length > 0)) {
                    hasTextOverBackground = true;
                    break;
                }
            }

            // Build formatted CSS with detailed comments for non-engineers
            var css = '/* ========================================\n' +
                '   COLOR PALETTE\n' +
                '   EDIT THIS SECTION to change the color scheme of your site.\n' +
                '   These color variables are used throughout the design.\n' +
                '   ======================================== */\n' +
                ':root {\n' +
                '  --p: ' + t.p + ';  /* Primary accent color */\n' +
                '  --s: ' + t.s + ';  /* Secondary accent color */\n' +
                '  --b1: ' + t.bg1 + ';  /* Background gradient start */\n' +
                '  --b2: ' + t.bg2 + ';  /* Background gradient end */\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   BASE STYLES\n' +
                '   These provide consistent spacing and box sizing.\n' +
                '   Generally safe to leave as-is.\n' +
                '   ======================================== */\n' +
                '* {\n' +
                '  margin: 0;\n' +
                '  padding: 0;\n' +
                '  box-sizing: border-box;\n' +
                '}\n\n' +
                'html {\n' +
                '  scroll-behavior: smooth;\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   TYPOGRAPHY AND LAYOUT\n' +
                '   EDIT THIS SECTION to change fonts and text styling.\n' +
                '   To use a different font, change "Titillium Web" and\n' +
                '   update the Google Font link in the <head>.\n' +
                '   ======================================== */\n' +
                'body {\n' +
                '  font-family: "Titillium Web", sans-serif;\n' +
                '  background: linear-gradient(135deg, var(--b1), var(--b2));\n' +
                '  color: #f5f5f5;\n' +
                '  line-height: 1.6;\n' +
                '}\n\n' +
                '/* High contrast mode (activated by toggle button) */\n' +
                'body[data-contrast="high"] {\n' +
                '  background: #000;\n' +
                '  color: #fff;\n' +
                '}\n\n' +
                '/* Main heading (your site title) */\n' +
                'h1 {\n' +
                '  font-size: clamp(2.5rem, 8vw, 5rem);\n' +
                '  font-weight: 700;\n' +
                '  margin-bottom: 1.5rem;\n' +
                '  background: linear-gradient(135deg, var(--p), #fff, var(--s));\n' +
                '  -webkit-background-clip: text;\n' +
                '  -webkit-text-fill-color: transparent;\n' +
                '}\n\n' +
                '/* Section headings (slide titles) */\n' +
                '/* EDIT THIS to change the size or style of slide titles */\n' +
                'h2 {\n' +
                '  font-size: clamp(2rem, 5vw, 3.5rem);\n' +
                '  font-weight: 700;\n' +
                '  margin-bottom: 2rem;\n' +
                '}\n\n' +
                '/* Paragraphs */\n' +
                'p {\n' +
                '  font-size: 1.1rem;\n' +
                '  color: rgba(255, 255, 255, 0.8);\n' +
                '  margin-bottom: 1rem;\n' +
                '}\n\n' +
                '/* Lists */\n' +
                'ul {\n' +
                '  margin-left: 2rem;\n' +
                '  margin-bottom: 1rem;\n' +
                '}\n\n' +
                'li {\n' +
                '  margin-bottom: 0.5rem;\n' +
                '  color: rgba(255, 255, 255, 0.8);\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   SECTION LAYOUT\n' +
                '   EDIT THIS SECTION to change spacing between slides.\n' +
                '   Each <section> represents one slide from your PowerPoint.\n' +
                '   ======================================== */\n' +
                'section {\n' +
                '  min-height: auto;\n' +
                '  display: flex;\n' +
                '  align-items: center;\n' +
                '  position: relative;\n' +
                '  overflow: hidden;\n' +
                '  padding: 72px 0;  /* EDIT: Spacing above/below each section */\n' +
                '}\n\n' +
                '/* On larger screens, make sections fill viewport */\n' +
                '@media (min-width: 1024px) {\n' +
                '  section {\n' +
                '    min-height: 100vh;\n' +
                '    padding: 0;\n' +
                '  }\n' +
                '}\n\n' +
                '/* Content container (keeps text readable width) */\n' +
                '.con {\n' +
                '  max-width: 1200px;  /* EDIT: Maximum width of content */\n' +
                '  margin: 0 auto;\n' +
                '  padding: 2rem;  /* EDIT: Inner spacing around content */\n' +
                '  width: 100%;\n' +
                '  position: relative;\n' +
                '  z-index: 10;\n' +
                '}\n\n' +
                '/* Overlay (darkens background images for text readability) */\n' +
                '.ov {\n' +
                '  position: absolute;\n' +
                '  top: 0;\n' +
                '  left: 0;\n' +
                '  width: 100%;\n' +
                '  height: 100%;\n' +
                '  background: linear-gradient(135deg, rgba(26, 10, 46, 0.8), rgba(26, 10, 46, 0.6));\n' +
                '  z-index: 2;\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   HERO SECTION (opening slide)\n' +
                '   ======================================== */\n' +
                '#hero {\n' +
                '  background: linear-gradient(135deg, var(--b1), var(--b2));\n' +
                '}\n\n' +
                '.hc {\n' +
                '  text-align: center;\n' +
                '  animation: fadeIn 1s;\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   ANIMATIONS\n' +
                '   EDIT THIS SECTION to change or disable animations.\n' +
                '   ======================================== */\n' +
                '@keyframes fadeIn {\n' +
                '  from {\n' +
                '    opacity: 0;\n' +
                '    transform: translateY(30px);\n' +
                '  }\n' +
                '  to {\n' +
                '    opacity: 1;\n' +
                '    transform: translateY(0);\n' +
                '  }\n' +
                '}\n\n' +
                '/* Respect user preference for reduced motion */\n' +
                '@media (prefers-reduced-motion: reduce) {\n' +
                '  *, *::before, *::after {\n' +
                '    animation-duration: 0.01ms !important;\n' +
                '    animation-iteration-count: 1 !important;\n' +
                '    transition-duration: 0.01ms !important;\n' +
                '  }\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   INTERACTIVE ELEMENTS\n' +
                '   Generally leave these as-is for accessibility.\n' +
                '   ======================================== */\n' +
                '/* Skip link (helps keyboard users) */\n' +
                '.skip-link {\n' +
                '  position: absolute;\n' +
                '  top: -40px;\n' +
                '  left: 0;\n' +
                '  background: #fff;\n' +
                '  color: #000;\n' +
                '  padding: 8px 16px;\n' +
                '  text-decoration: none;\n' +
                '  z-index: 10000;\n' +
                '  font-weight: 600;\n' +
                '  border: 2px solid #000;\n' +
                '}\n\n' +
                '.skip-link:focus {\n' +
                '  top: 0;\n' +
                '  outline: 2px solid #00d9ff;\n' +
                '  outline-offset: 2px;\n' +
                '}\n\n' +
                '/* Focus indicators (keyboard navigation) */\n' +
                'button:focus,\n' +
                'a:focus,\n' +
                '.contrast-toggle:focus {\n' +
                '  outline: 2px solid #00d9ff;\n' +
                '  outline-offset: 2px;\n' +
                '}\n\n' +
                '/* Scroll progress bar */\n' +
                '.pb {\n' +
                '  position: fixed;\n' +
                '  top: 0;\n' +
                '  left: 0;\n' +
                '  height: 4px;\n' +
                '  background: linear-gradient(90deg, var(--p), var(--s));\n' +
                '  z-index: 1000;\n' +
                '  width: 0;\n' +
                '  transition: width 0.3s;\n' +
                '}\n\n' +
                '/* High contrast toggle button */\n' +
                '.contrast-toggle {\n' +
                '  position: fixed;\n' +
                '  top: 1rem;\n' +
                '  right: 1rem;\n' +
                '  padding: 0.5rem 1rem;\n' +
                '  background: rgba(255, 255, 255, 0.1);\n' +
                '  border: 2px solid rgba(255, 255, 255, 0.2);\n' +
                '  color: #f5f5f5;\n' +
                '  cursor: pointer;\n' +
                '  border-radius: 0.5rem;\n' +
                '  z-index: 1001;\n' +
                '  font-family: inherit;\n' +
                '  font-weight: 600;\n' +
                '}\n\n' +
                'body[data-contrast="high"] .contrast-toggle {\n' +
                '  background: #fff;\n' +
                '  color: #000;\n' +
                '  border-color: #fff;\n' +
                '}\n\n' +
                '/* ========================================\n' +
                '   FOOTER\n' +
                '   EDIT THIS SECTION to change footer styling.\n' +
                '   ======================================== */\n' +
                'footer {\n' +
                '  padding: 2rem;\n' +
                '  border-top: 1px solid rgba(255, 255, 255, 0.1);\n' +
                '  text-align: center;\n' +
                '  color: rgba(255, 255, 255, 0.5);\n' +
                '}';

            var accessibilityReport = generateAccessibilityReport(slides, hasTextOverBackground);
            
            // Build comprehensive instructional HTML comments for designers/creatives
            var htmlComments = '<!--\n' +
                '  ========================================================================\n' +
                '  SCROLLYTELLING SITE - AUTO-GENERATED FROM YOUR POWERPOINT\n' +
                '  ========================================================================\n' +
                '  \n' +
                '  âš ï¸ IMPORTANT: This file was generated automatically.\n' +
                '  You are EXPECTED to review and edit it before publishing.\n' +
                '  \n' +
                '  WHAT YOU CAN SAFELY EDIT:\n' +
                '  âœ“ Any text between HTML tags (headings, paragraphs, list items)\n' +
                '  âœ“ Colors in the CSS (look for the COLOR PALETTE section)\n' +
                '  âœ“ Fonts (change "Titillium Web" to your preferred font)\n' +
                '  âœ“ Spacing values (look for "margin" and "padding" in CSS)\n' +
                '  âœ“ The title and tagline in the hero section\n' +
                '  âœ“ Copyright text in the footer\n' +
                '  \n' +
                '  WHAT WAS AUTOMATICALLY DECIDED (please verify):\n' +
                '  â€¢ Headings: Extracted from PowerPoint title placeholders or first text\n' +
                '  â€¢ Background images: Chosen based on size and aspect ratio similarity\n' +
                '  â€¢ Content order: Follows your slide order in PowerPoint\n' +
                '  â€¢ Alt text: Generated based on slide context\n' +
                '  \n' +
                '  STRUCTURE OF THIS FILE:\n' +
                '  â€¢ <head>: Contains the page title, fonts, and all CSS styling\n' +
                '  â€¢ <body>: Contains your visible content in sections\n' +
                '    - Hero section: Your opening slide with main title\n' +
                '    - Main sections: Each PowerPoint slide becomes one <section>\n' +
                '    - Footer: Copyright and closing information\n' +
                '  â€¢ <script>: JavaScript that makes interactive features work\n' +
                '  \n' +
                '  IMAGES:\n' +
                '  â€¢ All images are embedded as data URLs (base64)\n' +
                '  â€¢ This means the file is larger but completely self-contained\n' +
                '  â€¢ You can move this HTML file anywhere and images will still work\n' +
                '  â€¢ Background images are decorative CSS (no alt text needed)\n' +
                '  â€¢ Inline images have alt text for screen readers\n' +
                '  \n' +
                '  ACCESSIBILITY:\n' +
                '  â€¢ This site includes WCAG-ready features like skip links and focus indicators\n' +
                '  â€¢ Final accessibility depends on YOUR content (color contrast, meaningful text)\n' +
                '  â€¢ Test with a screen reader and keyboard navigation before publishing\n' +
                '  â€¢ Check the ACCESSIBILITY_REPORT.txt file in your download for details\n' +
                '  \n' +
                '  ========================================================================\n' +
                '-->\n';
            
            var result = '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width">\n  <title>' + escapeHtml(titleinp.value) + '</title>\n  <!-- Web Font: You can change this to a different Google Font if desired -->\n  <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">\n  <style>\n' + css + '\n  </style>\n</head>\n<body>\n' + htmlComments + '\n  <!-- SKIP LINK: Allows keyboard users to jump directly to content -->\n  <a href="#main" class="skip-link">Skip to main content</a>\n  \n  <!-- HIGH CONTRAST TOGGLE: Clicking this button switches to a black/white color scheme for better visibility -->\n  <button class="contrast-toggle" id="contrastBtn" aria-label="Toggle high contrast mode">High Contrast</button>\n  \n  <!-- PROGRESS BAR: Shows scroll progress as you move down the page -->\n  <div class="pb" id="pb"></div>\n  \n  <!-- ========================================\n       HERO SECTION: The opening section of your scrollytelling site\n       EDIT: You can change the title and tagline below\n       ======================================== -->\n  <header id="hero">\n    <div class="ov"></div>\n    <div class="con">\n      <div class="hc">\n        <h1>' + escapeHtml(titleinp.value) + '</h1>\n        <p style="font-size:1.3rem;color:rgba(255,255,255,0.6)">Scroll to explore</p>\n      </div>\n    </div>\n  </header>\n  \n  <!-- ========================================\n       MAIN CONTENT: Your slides appear below as sections\n       Each <section> represents one slide from your PowerPoint.\n       EDIT: You can change the text, images, and order as needed.\n       ======================================== -->\n  <main id="main">\n' + secs + '  </main>\n  \n  <!-- ========================================\n       FOOTER\n       EDIT: You can change the copyright text below\n       ======================================== -->\n  <footer>\n    <p>' + escapeHtml(copyinp.value) + '</p>\n  </footer>\n  \n  <!-- ========================================\n       JAVASCRIPT: Makes the interactive features work\n       \n       This script controls:\n       â€¢ Scroll progress bar (updates as you scroll)\n       â€¢ High contrast toggle button (switches color schemes)\n       \n       Generally safe to leave as-is unless you want to customize behavior.\n       ======================================== -->\n  <script>\n    // Update progress bar on scroll\n    window.addEventListener("scroll", function() {\n      var scrolled = window.scrollY;\n      var height = document.documentElement.scrollHeight - window.innerHeight;\n      document.getElementById("pb").style.width = (scrolled / height * 100) + "%";\n    });\n    \n    // Toggle high contrast mode\n    document.getElementById("contrastBtn").addEventListener("click", function() {\n      var isHigh = document.body.getAttribute("data-contrast") === "high";\n      if (isHigh) {\n        document.body.removeAttribute("data-contrast");\n        this.textContent = "High Contrast";\n      } else {\n        document.body.setAttribute("data-contrast", "high");\n        this.textContent = "Normal Contrast";\n      }\n    });\n  <\/script>\n</body>\n</html>';

            return result;
        }

        function generateAccessibilityReport(slides, hasTextOverBackground) {
            var report = [];
            report.push('ACCESSIBILITY REPORT');
            report.push('Generated: ' + new Date().toISOString());
            report.push('');
            report.push('=== IMPORTANT NOTES ===');
            report.push('This report covers the TECHNICAL accessibility features of the generated site.');
            report.push('WCAG compliance also depends on source content quality (e.g., meaningful');
            report.push('headings, sufficient color contrast, appropriate image usage).');
            report.push('');
            report.push('=== CONTENT SUMMARY ===');
            report.push('Total slides: ' + slides.length);
            
            var totalImages = 0;
            var imagesWithAlt = 0;
            var backgroundImages = 0;
            var inlineImages = 0;
            
            slides.forEach(function(slide) {
                if (slide.images.length > 0) {
                    totalImages += slide.images.length;
                    backgroundImages += 1; // First image is background
                    inlineImages += Math.max(0, slide.images.length - 1);
                    // Only inline images have alt text
                    imagesWithAlt += Math.max(0, slide.images.length - 1);
                }
            });
            
            report.push('Total images: ' + totalImages);
            report.push('Background images: ' + backgroundImages + ' (CSS decorative)');
            report.push('Inline images: ' + inlineImages);
            report.push('Images with alt text: ' + imagesWithAlt + ' (all inline images)');
            report.push('');
            report.push('=== WCAG-READY FEATURES ===');
            report.push('[âœ“] Skip link ("Skip to main content") for keyboard navigation');
            report.push('[âœ“] Semantic HTML structure (header, main, footer)');
            report.push('[âœ“] High contrast toggle button');
            report.push('[âœ“] Respects prefers-reduced-motion (disables animations)');
            report.push('[âœ“] Visible focus indicators on interactive elements');
            report.push('[âœ“] All inline images have descriptive alt text');
            report.push('[âœ“] Lazy loading enabled for images');
            report.push('[âœ“] Keyboard accessible (all functionality via keyboard)');
            report.push('[âœ“] ARIA labels on interactive controls');
            report.push('');
            report.push('=== BACKGROUND IMAGES (CSS) ===');
            report.push('Background images are implemented as CSS background-image properties.');
            report.push('Per WCAG guidelines, these are treated as DECORATIVE and do not require');
            report.push('alt text. All MEANINGFUL images must be inline <img> elements.');
            report.push('');
            if (hasTextOverBackground) {
                report.push('âš  WARNING: Text content is placed over background images.');
                report.push('  Ensure sufficient contrast between text and background.');
                report.push('  Test with high contrast mode and verify readability.');
                report.push('');
            }
            report.push('=== CONTENT-DEPENDENT COMPLIANCE ===');
            report.push('The following require manual verification:');
            report.push('- Color contrast ratios (text vs background)');
            report.push('- Heading structure and hierarchy');
            report.push('- Link text meaningfulness');
            report.push('- Image alt text accuracy and completeness');
            report.push('- Content readability and clarity');
            report.push('');
            report.push('=== LIMITATIONS DOCUMENTED ===');
            report.push('1. Heading detection: Attempts to find title placeholders first.');
            report.push('   - Searches for p:ph elements with type="title" or "ctrTitle"');
            report.push('   - Falls back to first non-bullet paragraph if no title placeholder found');
            report.push('   - Please verify all headings are correct and meaningful');
            report.push('');
            report.push('2. Background image selection: Uses aspect ratio + area heuristic.');
            
            // Add details about which heuristic was used per slide
            if (summaryData.backgroundHeuristic) {
                var usedAspectRatio = false;
                var usedFirstImage = false;
                for (var slideNum in summaryData.backgroundHeuristic) {
                    if (summaryData.backgroundHeuristic[slideNum] === 'aspect-ratio-and-area') {
                        usedAspectRatio = true;
                    } else {
                        usedFirstImage = true;
                    }
                }
                if (usedAspectRatio) {
                    report.push('   Most slides: Background chosen by aspect ratio similarity (16:9) + area.');
                }
                if (usedFirstImage) {
                    report.push('   Some slides: Fallback to first image when extents unavailable.');
                }
            } else {
                report.push('   Fallback to first referenced image when extents unavailable.');
            }
            report.push('');
            report.push('3. Bullet detection: Uses paragraph properties (a:pPr, a:buChar,');
            report.push('   a:buAutoNum) when available. Falls back to Unicode bullet character');
            report.push('   detection for plain text paragraphs.');
            report.push('');
            report.push('4. Background images: Cannot guarantee text contrast over backgrounds.');
            report.push('   Manual review recommended for slides with text over images.');
            report.push('');
            report.push('=== RECOMMENDATIONS ===');
            report.push('- Test with screen readers (NVDA, JAWS, VoiceOver)');
            report.push('- Verify keyboard navigation works for all content');
            report.push('- Check color contrast with tools like WebAIM Contrast Checker');
            report.push('- Test with high contrast mode enabled');
            report.push('- Review with prefers-reduced-motion enabled');
            report.push('- Validate with automated tools (axe, WAVE, Lighthouse)');
            report.push('');
            report.push('This converter generates WCAG-READY output with proper structure,');
            report.push('semantics, and accessibility features. Final compliance depends on');
            report.push('source content quality and manual verification.');
            
            if (summaryData.warnings.length > 0) {
                report.push('');
                report.push('=== PROCESSING WARNINGS ===');
                summaryData.warnings.forEach(function(w) {
                    report.push('- ' + w);
                });
            }
            
            return report.join('\n');
        }

        // Download functionality
        down.onclick = async function() {
            if (!zip || !html) return;
            
            down.disabled = true;
            announceToScreenReader('Preparing download...');
            
            try {
                var outputZip = new JSZip();
                
                // Add index.html
                outputZip.file('index.html', html);
                
                // Generate accessibility report with correct arguments
                var accessibilityReport = generateAccessibilityReport(slideData, hasTextOverBackground);
                outputZip.file('ACCESSIBILITY_REPORT.txt', accessibilityReport);
                
                // Generate the zip
                var blob = await outputZip.generateAsync({type: 'blob'});
                
                // Create user-friendly filename with date
                var now = new Date();
                var dateStr = now.getFullYear() + '-' + 
                             String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(now.getDate()).padStart(2, '0');
                var filename = sanitizeFilename('scrollytelling-' + dateStr + '.zip');
                
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                down.disabled = false;
                announceToScreenReader('Download complete');
                
            } catch (e) {
                statusEl.textContent = 'Download error: ' + e.message;
                statusEl.className = 'msg show err';
                // Set assertive for errors
                statusEl.setAttribute('aria-live', 'assertive');
                statusEl.setAttribute('role', 'alert');
                down.disabled = false;
                announceToScreenReader('Download failed');
            }
        };

        // Cancel button
        cancelBtn.onclick = function() {
            cancelled = true;
            cancelBtn.disabled = true;
            announceToScreenReader('Processing cancelled');
            resetProcessing();
        };

        function resetProcessing() {
            load.style.display = 'none';
            gen.disabled = false;
            cancelBtn.disabled = true;
            statusEl.textContent = 'Processing cancelled';
            statusEl.className = 'msg show warn';
            // Return to polite status for warnings
            statusEl.setAttribute('aria-live', 'polite');
            statusEl.setAttribute('role', 'status');
        }

        // Edit button
        edit.onclick = function() {
            prev.classList.remove('show');
            gen.disabled = false;
            announceToScreenReader('Returned to edit mode');
        };

        // Reset button
        reset.onclick = function() {
            file = null;
            inp.value = '';
            info.style.display = 'none';
            gen.disabled = true;
            cancelBtn.disabled = true;
            statusEl.classList.remove('show');
            prev.classList.remove('show');
            summary.classList.remove('show');
            titleinp.value = 'Driving Meaningful Health Change';
            copyinp.value = 'Â© 2026 The Gaf NYC';
            theme = 'cyber';
            slideData = [];
            summaryData = { slides: 0, images: [], warnings: [], errors: [] };
            
            document.querySelectorAll('.color-btn').forEach(function(b) { 
                b.classList.remove('active');
                b.setAttribute('aria-checked', 'false');
            });
            document.querySelectorAll('.color-btn')[0].classList.add('active');
            document.querySelectorAll('.color-btn')[0].setAttribute('aria-checked', 'true');
            
            announceToScreenReader('Form reset');
        };
    </script>
</body>
</html>
